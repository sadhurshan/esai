# Stage 01 Copilot Audit

## What exists today (UI, API, microservice, workflows, actions)
- Copilot UI inventory spans chat/widget/action/workflow components documented below, giving us clear entry points and reviewer screens ([resources/js/components/ai/*](resources/js/components/ai)).
- Front-end hits eleven dedicated hooks covering threads, messages, drafts, workflows, and tool starts, each mapped to `/v1/ai/...` envelopes in the API table.
- Laravel exposes dedicated controllers (`AiChatController`, `AiActionsController`, `AiWorkflowController`, etc.) plus admin analytics/search endpoints, all tied to middleware scopes in [routes/api.php#L238-L786](routes/api.php#L238-L786).
- Python microservice mirrors the procurement workflow template and action schemas, which map 1:1 to Laravel converters and TS renderers as summarized in "Workflows & Actions".

## What’s missing vs requirements (1–8)
- Full coverage is limited to sourcing + inventory analytics; receiving, invoicing, payments, quality, billing, and admin areas still lack actions/workflows/tools.
- Guided help exists only through ad-hoc warnings—no structured “teach me” flows, fallback steps, or entitlement-aware playbooks.
- Workspace tooling exposes RFQs, quotes, suppliers, inventory, and awards, leaving large data sets (receipts, invoices, maintenance executions) invisible to Copilot answers.

## Risks / unknowns
- **Workflow/microservice schema drift** — Laravel loads templates from [config/ai_workflows.php](config/ai_workflows.php) while the Python engine mirrors them in [ai_microservice/app.py#L406-L438](ai_microservice/app.py#L406-L438). There is no contract test ensuring both stay in sync, so template edits in one stack could break approvals without warning.
- **RBAC + entitlement coverage** — `ensure.ai.*` middleware only guards chat/workflow endpoints defined in [routes/api.php#L238-L335](routes/api.php#L238-L335). New tools or workflows risk shipping without plan/role checks because no automated audit ties `/docs/SECURITY_AND_RBAC.md` to actual policies.
- **Tool resolver scalability** — `WorkspaceToolResolver` executes synchronous queries inside `ChatService::resolveTools()` ([app/Services/Ai/ChatService.php#L34-L134](app/Services/Ai/ChatService.php#L34-L134)); long-running aggregations could starve chat streaming. Need async/offloaded tooling before adding invoice/receiving lookups.
- **Data retention + privacy** — `AiEvents` log payloads for drafts/workflows but there is no purge/retention automation noted in [docs/DEFINITION_OF_DONE.md](docs/DEFINITION_OF_DONE.md). Sensitive supplier pricing could remain indefinitely without governance.


## Next steps for Stage 02
- Align on Stage‑02 backlog priorities from the checklist below and secure owner + due date for each item.
- Stand up contract tests between Laravel + microservice workflows before expanding templates (ties into the receiving workflow stub task).
- Kick off RBAC/entitlement audit to guarantee new tools/actions come with policies and plan gating per [docs/SECURITY_AND_RBAC.md](docs/SECURITY_AND_RBAC.md).
- Schedule privacy/legal review for AiEvents retention so new telemetry features (Stage‑02 monitoring task) satisfy governance requirements.

## AI UI Entry Points
- [resources/js/components/ai/CopilotChatWidget.tsx](resources/js/components/ai/CopilotChatWidget.tsx) – Mounts the floating Copilot experience once the current user/plan clears `canUseAiCopilot`, injecting the chat bubble and slide-over dock via a document portal.
- [resources/js/components/ai/CopilotChatBubble.tsx](resources/js/components/ai/CopilotChatBubble.tsx) – Fixed FAB that opens/closes the widget, shows unread indicators, and exposes ARIA hooks for keyboard toggling.
- [resources/js/components/ai/CopilotChatDock.tsx](resources/js/components/ai/CopilotChatDock.tsx) – Right-side sheet container that hosts `CopilotChatPanel`, manages body scroll locking, and syncs with the widget store.
- [resources/js/components/ai/CopilotChatPanel.tsx](resources/js/components/ai/CopilotChatPanel.tsx) – Full conversation UI (threads list, composer, assistant responses, draft approvals, workflow triggers) riding on the chat hooks.
- [resources/js/components/ai/CopilotActionsPanel.tsx](resources/js/components/ai/CopilotActionsPanel.tsx) – Standalone action launcher that collects structured inputs per action type, calls plan/approve endpoints, and reuses `AiDraftReviewModal` for confirmations.
- [resources/js/components/ai/AiDraftReviewModal.tsx](resources/js/components/ai/AiDraftReviewModal.tsx) – Modal that summarizes Copilot action payloads, warnings, and citations before a human approves the conversion.
- [resources/js/components/ai/CopilotAnswerPanel.tsx](resources/js/components/ai/CopilotAnswerPanel.tsx) – Q&A surface for sourcing/maintenance questions, wiring `answerQuestion` to generate grounded markdown plus citation controls.
- [resources/js/components/ai/CopilotSearchPanel.tsx](resources/js/components/ai/CopilotSearchPanel.tsx) – Semantic search interface with filters/tags that opens cited documents via the documents API.
- [resources/js/components/ai/WorkflowPanel.tsx](resources/js/components/ai/WorkflowPanel.tsx) – Reviewer console showing workflow queues, step details, and approval/rejection affordances for `compare_quotes`/`po_draft` stages.
- [resources/js/components/ai/ForecastInsightCard.tsx](resources/js/components/ai/ForecastInsightCard.tsx) – Part-level insight card that calls `getForecast` to propose safety stock/reorder point adjustments and optional apply action.
- [resources/js/components/ai/SupplierRiskBadge.tsx](resources/js/components/ai/SupplierRiskBadge.tsx) – Badge + drawer that fetches supplier risk insights on demand; `LazySupplierRiskBadge` wraps it in suspense for optimistic loading.

## Chat Rendering + Filtering
- **Message loading** — `CopilotChatPanel` wires `useAiChatMessages(activeThreadId, { limit: 60 })` so every thread pull is capped at 60 most-recent turns, scoped per tenant ([resources/js/components/ai/CopilotChatPanel.tsx#L38-L70](resources/js/components/ai/CopilotChatPanel.tsx#L38-L70)). The hook re-fetches whenever the active thread id changes; bootstrap logic auto-opens the first thread or creates one if none exist.
- **Filtering + hidden roles** — `visibleMessages` memo strips every `tool` role (workspace resolver payloads) and suppresses assistant turns whose response envelope is a `tool_request`, ensuring only authored user/assistant/system bubbles render ([resources/js/components/ai/CopilotChatPanel.tsx#L71-L114](resources/js/components/ai/CopilotChatPanel.tsx#L71-L114)). System notices (e.g., approvals) do display since they include `content_text`.
- **Assistant response routing** — Each assistant message is parsed via `extractAssistantResponse`, which determines whether the payload represents a grounded `answer`, `draft_action`, `workflow_suggestion`, `tool_request`, or `error`. `AssistantDetails` then decides whether to mount `DraftPreview`, `WorkflowPreview`, or warning banners ([resources/js/components/ai/CopilotChatPanel.tsx#L474-L666](resources/js/components/ai/CopilotChatPanel.tsx#L474-L666)). Drafts surface approve/reject callbacks; workflow suggestions wire into `handleStartWorkflowSuggestion` to kick off `/v1/ai/workflows/start`.
- **Quick replies + status banners** — The panel inspects the last assistant response for `suggested_quick_replies`, `needs_human_review`, and `warnings`, surfacing them inline ([resources/js/components/ai/CopilotChatPanel.tsx#L118-L205](resources/js/components/ai/CopilotChatPanel.tsx#L118-L205)).
- **Rendering sequence** —

```
User prompt → useAiChatSend → ChatService::sendMessage → assistant payload persisted
	 ↓                                                         ↑
 messagesQuery (limit 60) ← AiChatThread messages ← tool messages stored but filtered
	 ↓
 visibleMessages (user | assistant | system only)
	 ↓
 AssistantBubble → AssistantDetails
		  ↳ type === 'draft_action' → DraftPreview → approve/reject hooks
		  ↳ type === 'workflow_suggestion' → WorkflowPreview → start workflow
		  ↳ type === 'tool_request' → hidden until tool round completes
```

## API Hooks Inventory
Front-end chat/workflow surfaces only call the hooks below; every entry wraps the JSON envelope described in [docs/API_ENVELOPE.md](docs/API_ENVELOPE.md) and scopes requests by the active tenant/thread/workflow id.

| Hook | HTTP surface | Returns | Consuming UI |
| --- | --- | --- | --- |
| `useAiChatThreads` ([resources/js/hooks/api/ai/use-ai-chat-threads.ts#L1-L63](resources/js/hooks/api/ai/use-ai-chat-threads.ts#L1-L63)) | `GET /v1/ai/chat/threads?status[]=...&cursor=...&per_page=...` | `{ items: AiChatThread[], meta }` cursor payload for the chat sidebar | Thread list inside [resources/js/components/ai/CopilotChatPanel.tsx#L38-L120](resources/js/components/ai/CopilotChatPanel.tsx#L38-L120)
| `useCreateAiChatThread` ([resources/js/hooks/api/ai/use-ai-chat-threads.ts#L65-L114](resources/js/hooks/api/ai/use-ai-chat-threads.ts#L65-L114)) | `POST /v1/ai/chat/threads` with optional `{ title }` | Newly created `AiChatThread` | New-thread CTA in [resources/js/components/ai/CopilotChatPanel.tsx#L121-L204](resources/js/components/ai/CopilotChatPanel.tsx#L121-L204)
| `useAiChatMessages` ([resources/js/hooks/api/ai/use-ai-chat-messages.ts#L1-L54](resources/js/hooks/api/ai/use-ai-chat-messages.ts#L1-L54)) | `GET /v1/ai/chat/threads/{threadId}?limit={n}` | Single `AiChatThread` (messages limited to `limit`) | Message list + composer state in [resources/js/components/ai/CopilotChatPanel.tsx#L38-L204](resources/js/components/ai/CopilotChatPanel.tsx#L38-L204)
| `useAiChatSend` ([resources/js/hooks/api/ai/use-ai-chat-send.ts#L1-L333](resources/js/hooks/api/ai/use-ai-chat-send.ts#L1-L333)) | `POST /v1/ai/chat/threads/{id}/send` (sync), SSE `GET /api/v1/ai/chat/threads/{id}/stream?token=...` (stream), and `POST /v1/ai/chat/threads/{id}/tools/resolve` for tool loops | User/assistant message pair plus any tool-turn resolutions | Composer in [resources/js/components/ai/CopilotChatPanel.tsx#L205-L473](resources/js/components/ai/CopilotChatPanel.tsx#L205-L473)
| `useAiDraftApprove` ([resources/js/hooks/api/ai/use-ai-draft-approval.ts#L1-L46](resources/js/hooks/api/ai/use-ai-draft-approval.ts#L1-L46)) | `POST /v1/ai/drafts/{draftId}/approve` with `{ thread_id }` | Updated `AiActionDraftResponse` (status → approved) | Draft cards rendered by `DraftPreview` inside [resources/js/components/ai/CopilotChatPanel.tsx#L535-L666](resources/js/components/ai/CopilotChatPanel.tsx#L535-L666)
| `useAiDraftReject` ([resources/js/hooks/api/ai/use-ai-draft-approval.ts#L48-L86](resources/js/hooks/api/ai/use-ai-draft-approval.ts#L48-L86)) | `POST /v1/ai/drafts/{draftId}/reject` with `{ thread_id, reason }` | `AiActionDraftResponse` reflecting rejection notes | Same DraftPreview + `AiDraftReviewModal` surfaces
| `useStartAiWorkflow` ([resources/js/hooks/api/ai/use-start-ai-workflow.ts#L1-L44](resources/js/hooks/api/ai/use-start-ai-workflow.ts#L1-L44)) | `POST /v1/ai/workflows/start` — optional `thread_id`, `workflow_type`, RFQ inputs | `{ workflow_id }` for the created workflow | Workflow suggestions in [resources/js/components/ai/CopilotChatPanel.tsx#L552-L840](resources/js/components/ai/CopilotChatPanel.tsx#L552-L840)
| `useAiWorkflows` ([resources/js/hooks/api/ai/use-ai-workflows.ts#L1-L78](resources/js/hooks/api/ai/use-ai-workflows.ts#L1-L78)) | `GET /v1/ai/workflows?status[]=...&workflow_type=...&cursor=...` | `{ items: AiWorkflowSummary[], meta }` | Queue list in [resources/js/components/ai/WorkflowPanel.tsx#L131-L214](resources/js/components/ai/WorkflowPanel.tsx#L131-L214)
| `useAiWorkflowStep` ([resources/js/hooks/api/ai/use-ai-workflow-step.ts#L1-L44](resources/js/hooks/api/ai/use-ai-workflow-step.ts#L1-L44)) | `GET /v1/ai/workflows/{workflowId}/next` | `{ workflow, step, next_step }` snapshot | Active step detail view in [resources/js/components/ai/WorkflowPanel.tsx#L215-L492](resources/js/components/ai/WorkflowPanel.tsx#L215-L492)
| `useResolveAiWorkflowStep` ([resources/js/hooks/api/ai/use-resolve-ai-workflow-step.ts#L1-L55](resources/js/hooks/api/ai/use-resolve-ai-workflow-step.ts#L1-L55)) | `POST /v1/ai/workflows/{workflowId}/complete` with `{ step_index, approval, output, notes }` | Updated workflow + next step payload | Approve/Reject buttons in [resources/js/components/ai/WorkflowPanel.tsx#L493-L1056](resources/js/components/ai/WorkflowPanel.tsx#L493-L1056)

## Controllers & Routes
- **AiActionsController** ([app/Http/Controllers/Api/V1/AiActionsController.php#L44-L369](app/Http/Controllers/Api/V1/AiActionsController.php#L44-L369)) — orchestrates Copilot action planning plus draft approvals, rejections, and feedback. Protected by buyer-access middleware, it persists drafts, calls `AiDraftConversionService`, and appends chat system notices after approvals. Routes live under `Route::prefix('v1/ai/actions')` and `Route::prefix('v1/ai/drafts')` with rate limiting per [routes/api.php#L252-L307](routes/api.php#L252-L307):
	- `POST /v1/ai/actions/plan` → generates a draft via the Python microservice (`AiClient::planAction`).
	- `POST /v1/ai/actions/{draft}/approve|reject|feedback` and the duplicate `/v1/ai/drafts/{draft}/approve|reject` aliases → resolve draft lifecycle while logging AiEvents.
- **AiChatController** ([app/Http/Controllers/Api/V1/AiChatController.php#L33-L332](app/Http/Controllers/Api/V1/AiChatController.php#L33-L332)) — owns chat threads, message pagination, streaming setup, and workspace tool resolution. Endpoints (`GET/POST /v1/ai/chat/threads`, `/stream`, `/send`, `/tools/resolve`) inherit the shared Copilot middleware + AI availability gates defined in [routes/api.php#L287-L307](routes/api.php#L287-L307).
- **AiWorkflowController** ([app/Http/Controllers/Api/V1/AiWorkflowController.php#L36-L320](app/Http/Controllers/Api/V1/AiWorkflowController.php#L36-L320)) — indexes workflows, starts templates, drafts next steps, streams AiEvents, and completes approvals while calling `WorkflowService`. All verbs sit under `/v1/ai/workflows` with `ensure.ai.workflows.access` plus rate limiting ([routes/api.php#L309-L335](routes/api.php#L309-L335)).
- **AiController** ([app/Http/Controllers/Api/V1/AiController.php#L27-L156](app/Http/Controllers/Api/V1/AiController.php#L27-L156)) — exposes non-chat AI helpers: `POST /ai/forecast` and `POST /ai/supplier-risk`, each with inventory or risk permission middleware ([routes/api.php#L238-L259](routes/api.php#L238-L259)). Both endpoints proxy to `AiClient` and emit AiEvents with latency metrics.
- **CopilotSearchController** ([app/Http/Controllers/Api/Ai/CopilotSearchController.php#L31-L196](app/Http/Controllers/Api/Ai/CopilotSearchController.php#L31-L196)) — powers the semantic search + grounded answer surfaces. Routes `POST /copilot/search` and `POST /copilot/answer` are wrapped in Copilot middleware/rate limits ([routes/api.php#L770-L783](routes/api.php#L770-L783)) and enforce document ACLs via `DocumentAccessPolicy`.
- **CopilotController** ([app/Http/Controllers/Api/CopilotController.php#L26-L138](app/Http/Controllers/Api/CopilotController.php#L26-L138)) — legacy analytics Copilot endpoint `POST /copilot/analytics`, guarded by `ensure.analytics.access` ([routes/api.php#L783-L786](routes/api.php#L783-L786)), which inspects the prompt for supported KPIs before returning `AnalyticsSnapshotResource` collections.
- **AiDocumentIndexController** ([app/Http/Controllers/Api/Ai/AiDocumentIndexController.php#L15-L76](app/Http/Controllers/Api/Ai/AiDocumentIndexController.php#L15-L76)) — admin-only `POST /v1/admin/ai/reindex-document` hook to requeue embeddings via `IndexDocumentForSearchJob`, scoped by tenant ([routes/api.php#L260-L269](routes/api.php#L260-L269)).
- **Admin\AiTrainingController** ([app/Http/Controllers/Admin/AiTrainingController.php#L22-L111](app/Http/Controllers/Admin/AiTrainingController.php#L22-L111)) — super-admin endpoints under `/v1/admin/ai-training` for listing training jobs, starting new runs, showing job state, and forcing refreshes ([routes/api.php#L335-L365](routes/api.php#L335-L366)).
- **Admin\AiModelMetricController** ([app/Http/Controllers/Admin/AiModelMetricController.php#L15-L43](app/Http/Controllers/Admin/AiModelMetricController.php#L15-L43)) — paginated analytics for model KPIs via `/v1/admin/ai-model-metrics` (same admin/ai-training middleware group) to audit microservice quality.
- **Admin\AiEventController** ([app/Http/Controllers/Admin/AiEventController.php#L15-L45](app/Http/Controllers/Admin/AiEventController.php#L15-L45)) — exposes `/v1/admin/ai-events` listing so platform ops can review AiEvent telemetry with feature/status/entity filters.

## Workflows & Actions
- **Workflow templates** — `config/ai_workflows.php` defines a single `procurement` track (`rfq_draft → compare_quotes → po_draft`) with per-step approval permissions ([config/ai_workflows.php#L1-L23](config/ai_workflows.php#L1-L23)). The Python service mirrors that template via `WORKFLOW_STEP_TEMPLATES` so both engines stay in lockstep ([ai_microservice/app.py#L406-L438](ai_microservice/app.py#L406-L438)). `WorkflowService` simply loads the config, calls the microservice to draft each step, and persists `AiWorkflowStep` rows before routing approvals to the correct converter ([app/Services/Ai/WorkflowService.php#L28-L320](app/Services/Ai/WorkflowService.php#L28-L320)).
- **Canonical action types** — Front-end enums live in [resources/js/services/ai.ts#L42-L110](resources/js/services/ai.ts#L42-L110) and exactly match the back-end constants in [app/Models/AiActionDraft.php#L9-L54](app/Models/AiActionDraft.php#L9-L54). The microservice enforces schemas per action type via `ACTION_SCHEMA_BY_TYPE` ([ai_microservice/app.py#L408-L436](ai_microservice/app.py#L408-L436)) and `*_SCHEMA` definitions in [ai_microservice/schemas.py#L411-L433](ai_microservice/schemas.py#L411-L433). End-to-end ownership for each action/workflow artifact:

| action_type | Microservice schema / template | Laravel conversion / service | UI renderer |
| --- | --- | --- | --- |
| `rfq_draft` | `RFQ_DRAFT_SCHEMA` payload enforces title, scope, line items, rubric, and supplier questions ([ai_microservice/schemas.py#L411-L472](ai_microservice/schemas.py#L411-L472)) | `RfqDraftConverter` creates RFQs + items + rubrics once a draft is approved ([app/Services/Ai/Converters/RfqDraftConverter.php#L5-L210](app/Services/Ai/Converters/RfqDraftConverter.php#L5-L210)) | Action launcher + draft preview flows in [resources/js/components/ai/CopilotActionsPanel.tsx#L60-L875](resources/js/components/ai/CopilotActionsPanel.tsx#L60-L875) and [resources/js/components/ai/AiDraftReviewModal.tsx#L20-L210](resources/js/components/ai/AiDraftReviewModal.tsx#L20-L210)
| `supplier_message` | `SUPPLIER_MESSAGE_SCHEMA` captures outbound message body, recipients, and attachments ([ai_microservice/schemas.py#L415-L420](ai_microservice/schemas.py#L415-L420)) | `SupplierMessageDraftConverter` writes communications + audit entries ([app/Services/Ai/Converters/SupplierMessageDraftConverter.php#L5-L180](app/Services/Ai/Converters/SupplierMessageDraftConverter.php#L5-L180)) | Same CopilotActionsPanel + AiDraftReviewModal paths render approvals with supplier context ([resources/js/components/ai/CopilotActionsPanel.tsx#L480-L1040](resources/js/components/ai/CopilotActionsPanel.tsx#L480-L1040))
| `maintenance_checklist` | `MAINTENANCE_CHECKLIST_SCHEMA` ensures tasks, intervals, and linked inventory are provided ([ai_microservice/schemas.py#L419-L422](ai_microservice/schemas.py#L419-L422)) | `MaintenanceChecklistDraftConverter` upserts preventive maintenance templates ([app/Services/Ai/Converters/MaintenanceChecklistDraftConverter.php#L5-L190](app/Services/Ai/Converters/MaintenanceChecklistDraftConverter.php#L5-L190)) | Rendered inside the same draft preview stack with checklist-specific fields ([resources/js/components/ai/CopilotActionsPanel.tsx#L960-L1296](resources/js/components/ai/CopilotActionsPanel.tsx#L960-L1296))
| `inventory_whatif` | `INVENTORY_WHATIF_SCHEMA` models scenario inputs (demand shocks, safety stock adjustments) ([ai_microservice/schemas.py#L423-L426](ai_microservice/schemas.py#L423-L426)) | `InventoryWhatIfConverter` logs the what-if, creates recommendations, and links affected SKUs ([app/Services/Ai/Converters/InventoryWhatIfConverter.php#L5-L210](app/Services/Ai/Converters/InventoryWhatIfConverter.php#L5-L210)) | Preview + approvals handled by CopilotActionsPanel when the assistant emits `draft_action` entries ([resources/js/components/ai/CopilotChatPanel.tsx#L535-L666](resources/js/components/ai/CopilotChatPanel.tsx#L535-L666))
| `compare_quotes` | Workflow-only schema `QUOTE_COMPARISON_SCHEMA` provides normalized quote rows + scoring ([ai_microservice/schemas.py#L427-L430](ai_microservice/schemas.py#L427-L430)); part of the `procurement` template ([ai_microservice/app.py#L426-L432](ai_microservice/app.py#L426-L432)) | `QuoteComparisonDraftConverter` handles approvals, writing comparison snapshots and awards ([app/Services/Ai/Workflow/QuoteComparisonDraftConverter.php#L5-L210](app/Services/Ai/Workflow/QuoteComparisonDraftConverter.php#L5-L210)) | `WorkflowPanel` renders ranking widgets + selection logic for this step ([resources/js/components/ai/WorkflowPanel.tsx#L165-L875](resources/js/components/ai/WorkflowPanel.tsx#L165-L875))
| `po_draft` | Workflow template step using `PO_DRAFT_SCHEMA` to describe header + line items ([ai_microservice/schemas.py#L431-L433](ai_microservice/schemas.py#L431-L433)) | `PurchaseOrderDraftConverter` builds/updates POs and links awards when reviewers approve ([app/Services/Ai/Workflow/PurchaseOrderDraftConverter.php#L5-L210](app/Services/Ai/Workflow/PurchaseOrderDraftConverter.php#L5-L210)) | `WorkflowPanel` enforces acknowledgment toggles before `po_draft` approvals ([resources/js/components/ai/WorkflowPanel.tsx#L493-L1056](resources/js/components/ai/WorkflowPanel.tsx#L493-L1056))

## Draft Action Flow
Copilot emits `AiChatAssistantResponse.type === 'draft_action'` (see [resources/js/types/ai-chat.ts#L1-L47](resources/js/types/ai-chat.ts#L1-L47)) whenever the LLM can fully draft an artifact. The pipeline is:

1. **UI intent + API call** — When a buyer clicks “Plan action” in `CopilotActionsPanel`, the payload uses the constrained enum in [resources/js/services/ai.ts#L42-L118](resources/js/services/ai.ts#L42-L118) and posts to `POST /v1/ai/actions/plan`. Inside chat, `useAiChatSend` calls `AiChatController::send`, which delegates to `ChatService::sendMessage` ([resources/js/components/ai/CopilotActionsPanel.tsx#L447-L875](resources/js/components/ai/CopilotActionsPanel.tsx#L447-L875), [resources/js/hooks/api/ai/use-ai-chat-send.ts#L222-L520](resources/js/hooks/api/ai/use-ai-chat-send.ts#L222-L520), [app/Http/Controllers/Api/V1/AiChatController.php#L172-L221](app/Http/Controllers/Api/V1/AiChatController.php#L172-L221)).
2. **Draft persistence** — Every assistant response runs through `ChatService::attachDraftSnapshot()`, which materializes an `AiActionDraft` row with `STATUS_DRAFTED`, snapshotting the prompt, company, context, and citations ([app/Services/Ai/ChatService.php#L780-L860](app/Services/Ai/ChatService.php#L780-L860)). The model’s `ACTION_TYPES` constants ([app/Models/AiActionDraft.php#L9-L54](app/Models/AiActionDraft.php#L9-L54)) keep backend storage aligned with the TS enum above.
3. **Draft rendering & gating** — `CopilotChatPanel` filters visible messages but renders draft cards via `AssistantDetails`/`DraftPreview`, wiring `handleApproveDraftAction` and `handleRejectDraftAction` so each card can call the approval hooks ([resources/js/components/ai/CopilotChatPanel.tsx#L60-L315](resources/js/components/ai/CopilotChatPanel.tsx#L60-L315), [resources/js/components/ai/CopilotChatPanel.tsx#L508-L705](resources/js/components/ai/CopilotChatPanel.tsx#L508-L705)). Pending state in `draftActionState` keeps the CTA spinners in sync.
4. **Approve/Reject endpoints** — `useAiDraftApprove` / `useAiDraftReject` hit `POST /v1/ai/drafts/{id}/approve|reject` with the active thread id ([resources/js/hooks/api/ai/use-ai-draft-approval.ts#L1-L86](resources/js/hooks/api/ai/use-ai-draft-approval.ts#L1-L86)). `AiActionsController::approve` and `::reject` verify the draft belongs to the tenant, confirm it’s still `drafted`, and append system messages back into the chat thread ([app/Http/Controllers/Api/V1/AiActionsController.php#L140-L308](app/Http/Controllers/Api/V1/AiActionsController.php#L140-L308)).
5. **Conversion services** — Approved drafts flow through `AiDraftConversionService::convert()`, which dispatches to the module-specific converter (`RfqDraftConverter`, `SupplierMessageDraftConverter`, `MaintenanceChecklistDraftConverter`, `InventoryWhatIfConverter`) before returning entity metadata for toast messaging ([app/Services/Ai/Converters/AiDraftConversionService.php#L10-L43](app/Services/Ai/Converters/AiDraftConversionService.php#L10-L43), [app/Services/Ai/Converters/RfqDraftConverter.php#L5-L210](app/Services/Ai/Converters/RfqDraftConverter.php#L5-L210), [app/Services/Ai/Converters/SupplierMessageDraftConverter.php#L5-L180](app/Services/Ai/Converters/SupplierMessageDraftConverter.php#L5-L180), [app/Services/Ai/Converters/MaintenanceChecklistDraftConverter.php#L5-L190](app/Services/Ai/Converters/MaintenanceChecklistDraftConverter.php#L5-L190), [app/Services/Ai/Converters/InventoryWhatIfConverter.php#L5-L210](app/Services/Ai/Converters/InventoryWhatIfConverter.php#L5-L210)). Each converter enforces business validation + audit logging so Copilot never bypasses existing create flows.
6. **Non-draft outputs** — Purchase order content ships as `workflow_suggestion`, triggering the workflow pipeline instead of the draft path. `buildWorkflowStartVariables` marshals the suggestion into `useStartAiWorkflow`, which then hands off to the workflow engine covered below ([resources/js/components/ai/CopilotChatPanel.tsx#L552-L840](resources/js/components/ai/CopilotChatPanel.tsx#L552-L840), [resources/js/hooks/api/ai/use-start-ai-workflow.ts#L1-L44](resources/js/hooks/api/ai/use-start-ai-workflow.ts#L1-L44)).

## Workflow Flow
Workflow suggestions coming from chat transition into the workflow subsystem, which enforces per-step approvals before any `po_draft` hits purchasing.

- **Suggestion → kickoff** — When the assistant proposes a workflow, `WorkflowPreview` lets the user press “Start workflow”, which calls `useStartAiWorkflow` → `POST /v1/ai/workflows/start` ([resources/js/hooks/api/ai/use-start-ai-workflow.ts#L1-L44](resources/js/hooks/api/ai/use-start-ai-workflow.ts#L1-L44)). `AiWorkflowController::start` enriches the payload with user context, optional chat thread metadata, and calls `WorkflowService::startWorkflow` ([app/Http/Controllers/Api/V1/AiWorkflowController.php#L87-L132](app/Http/Controllers/Api/V1/AiWorkflowController.php#L87-L132), [app/Services/Ai/WorkflowService.php#L28-L92](app/Services/Ai/WorkflowService.php#L28-L92)). The service plans the template defined in [config/ai_workflows.php#L4-L16](config/ai_workflows.php#L4-L16) — today that means `rfq_draft → compare_quotes → po_draft` for procurement — and stores both the workflow row and its individual steps.
- **Engine + states** — The Python microservice keeps the authoritative state machine (see `TERMINAL_STATUSES` and getters in [ai_microservice/workflow_engine.py#L14-L196](ai_microservice/workflow_engine.py#L14-L196)). Laravel mirrors those states via `AiWorkflow.status` / `AiWorkflowStep.approval_status`, and the TypeScript client relies on the same enum set ([resources/js/types/ai-workflows.ts#L1-L36](resources/js/types/ai-workflows.ts#L1-L36)).
- **Reviewer UI** — `WorkflowPanel` lists workflows with `useAiWorkflows` (cursor-paginated GET `/v1/ai/workflows`) and autoloads the active step via `useAiWorkflowStep` (GET `/v1/ai/workflows/{id}/next`) ([resources/js/components/ai/WorkflowPanel.tsx#L131-L214](resources/js/components/ai/WorkflowPanel.tsx#L131-L214), [resources/js/hooks/api/ai/use-ai-workflows.ts#L1-L78](resources/js/hooks/api/ai/use-ai-workflows.ts#L1-L78), [resources/js/hooks/api/ai/use-ai-workflow-step.ts#L1-L44](resources/js/hooks/api/ai/use-ai-workflow-step.ts#L1-L44)). The component derives quote and PO draft helpers (`parseQuoteDraft`, `parsePoDraft`) so approvers can rank suppliers or inspect PO line items before acting ([resources/js/components/ai/WorkflowPanel.tsx#L165-L330](resources/js/components/ai/WorkflowPanel.tsx#L165-L330), [resources/js/components/ai/WorkflowPanel.tsx#L493-L875](resources/js/components/ai/WorkflowPanel.tsx#L493-L875)).
- **Drafting the next step** — `AiWorkflowController::next` calls `WorkflowService::draftNextStep`, which in turn calls the microservice to pull the next unresolved step, persists the draft JSON on `AiWorkflowStep`, and updates `current_step` ([app/Http/Controllers/Api/V1/AiWorkflowController.php#L133-L187](app/Http/Controllers/Api/V1/AiWorkflowController.php#L133-L187), [app/Services/Ai/WorkflowService.php#L93-L139](app/Services/Ai/WorkflowService.php#L93-L139)). That’s how a `po_draft` payload ends up attached to the step the panel is rendering.
- **Resolution + converters** — Approvals/rejections go through `useResolveAiWorkflowStep` → `POST /v1/ai/workflows/{id}/complete`, which is handled by `AiWorkflowController::complete` and `WorkflowService::completeCurrentStep` ([resources/js/hooks/api/ai/use-resolve-ai-workflow-step.ts#L1-L55](resources/js/hooks/api/ai/use-resolve-ai-workflow-step.ts#L1-L55), [app/Http/Controllers/Api/V1/AiWorkflowController.php#L222-L306](app/Http/Controllers/Api/V1/AiWorkflowController.php#L222-L306), [app/Services/Ai/WorkflowService.php#L141-L320](app/Services/Ai/WorkflowService.php#L141-L320)). When a step is approved the service calls `runConverter()`, which routes to `QuoteComparisonDraftConverter` or `PurchaseOrderDraftConverter` depending on `action_type` ([app/Services/Ai/WorkflowService.php#L363-L380](app/Services/Ai/WorkflowService.php#L363-L380)). The PO converter creates/updates purchase orders, synchronizes line items, and links awards to the new PO ([app/Services/Ai/Workflow/PurchaseOrderDraftConverter.php#L5-L210](app/Services/Ai/Workflow/PurchaseOrderDraftConverter.php#L5-L210)). Quote comparisons similarly shortlist quotes and optionally award supplier items ([app/Services/Ai/Workflow/QuoteComparisonDraftConverter.php#L5-L210](app/Services/Ai/Workflow/QuoteComparisonDraftConverter.php#L5-L210)).
- **Reviewer safeguards** — `WorkflowPanel` enforces auth scopes plus PO-specific acknowledgements before enabling “Approve”. For `po_draft` steps the reviewer must check the confirmation box before `buildCompletionOutput()` assembles the approval payload ([resources/js/components/ai/WorkflowPanel.tsx#L185-L258](resources/js/components/ai/WorkflowPanel.tsx#L185-L258), [resources/js/components/ai/WorkflowPanel.tsx#L1004-L1056](resources/js/components/ai/WorkflowPanel.tsx#L1004-L1056)). This preserves the “AI drafts, humans approve” contract the spec requires.

## Tooling & Workspace Grounding
All tool-grounded answers flow through `ChatService::resolveTools()`, which caps each assistant turn at five workspace lookups and delegates the heavy lifting to `WorkspaceToolResolver` ([app/Services/Ai/ChatService.php#L34-L134](app/Services/Ai/ChatService.php#L34-L134), [app/Services/Ai/WorkspaceToolResolver.php#L18-L40](app/Services/Ai/WorkspaceToolResolver.php#L18-L40)). `CopilotChatPanel` suppresses raw `tool` and `tool_request` messages so only authored turns render, but the assistant response still notes when a lookup occurred ([resources/js/components/ai/CopilotChatPanel.tsx#L71-L115](resources/js/components/ai/CopilotChatPanel.tsx#L71-L115)). Every supported tool, its resolver, and the returned data today:

| Tool name | Resolver method | Surface area |
| --- | --- | --- |
| `workspace.search_rfqs` | `handleSearchRfqs()` ([app/Services/Ai/WorkspaceToolResolver.php#L92-L149](app/Services/Ai/WorkspaceToolResolver.php#L92-L149)) | Keyword + status-filtered RFQs (limit 5–25) along with `status_counts`, last-updated ordering, and ISO timestamps so the LLM can cite schedule info. |
| `workspace.get_rfq` | `handleGetRfq()` ([app/Services/Ai/WorkspaceToolResolver.php#L207-L251](app/Services/Ai/WorkspaceToolResolver.php#L207-L251)) | Full RFQ header plus first 10 items and latest 5 awards, including counts of quotes/items for context. |
| `workspace.list_suppliers` | `handleListSuppliers()` ([app/Services/Ai/WorkspaceToolResolver.php#L262-L301](app/Services/Ai/WorkspaceToolResolver.php#L262-L301)) | Supplier directory slice with location, lead time, rating, and risk grade plus optional country/search filters. |
| `workspace.get_quotes_for_rfq` | `handleGetQuotesForRfq()` ([app/Services/Ai/WorkspaceToolResolver.php#L308-L347](app/Services/Ai/WorkspaceToolResolver.php#L308-L347)) | Quotes for a given RFQ id including supplier city/country, totals, currency, lead time, and submission timestamps (limit 5–25). |
| `workspace.get_inventory_item` | `handleGetInventoryItem()` ([app/Services/Ai/WorkspaceToolResolver.php#L353-L405](app/Services/Ai/WorkspaceToolResolver.php#L353-L405)) | Item master lookup by id or SKU with on-hand/allocated/on-order balances plus the configured min/max/safety/reorder settings so Copilot can reason about coverage. |
| `workspace.low_stock` | `handleLowStock()` ([app/Services/Ai/WorkspaceToolResolver.php#L413-L458](app/Services/Ai/WorkspaceToolResolver.php#L413-L458)) | Ranks parts whose on-hand falls below `min_qty`, returning `coverage_ratio`, `safety_stock`, and aggregate metadata about how many records were evaluated. |
| `workspace.get_awards` | `handleGetAwards()` ([app/Services/Ai/WorkspaceToolResolver.php#L472-L516](app/Services/Ai/WorkspaceToolResolver.php#L472-L516)) | Most recent RFQ awards, including supplier identity, quantities, status, and awarded timestamps (limit 5–25). |
| `workspace.stats_quotes` | `handleQuoteStats()` ([app/Services/Ai/WorkspaceToolResolver.php#L153-L205](app/Services/Ai/WorkspaceToolResolver.php#L153-L205)) | Quote status census plus the latest submissions, vendor info, totals, and status counts so Copilot can cite sourcing throughput. |

Resolver helpers enforce tenant scoping, sanitize status filters, and normalize ids (`sanitizeLimit`, `coerceId`, `sanitizeStatuses`) before querying. `MAX_TOOL_CALLS` is hard-limited to 5 per assistant turn to prevent runaway tool spam ([app/Services/Ai/WorkspaceToolResolver.php#L18-L37](app/Services/Ai/WorkspaceToolResolver.php#L18-L37)). The chat timeline hides raw tool payloads, but the assistant labels responses as “Workspace lookup needed” when a tool round is in progress, letting users know when an answer is grounded by these resolvers.

## Gap vs Requirements (1–8)
| # | Requirement | Status | Evidence | Gap / Next Need |
| --- | --- | --- | --- | --- |
| 1 | "Users should be able to do anything in the application using the Copilot." | ❌ Not met | Copilot can only draft RFQs, supplier messages, maintenance plans, inventory what-ifs, and the procurement workflow `rfq_draft → compare_quotes → po_draft` ([resources/js/components/ai/CopilotActionsPanel.tsx#L60-L1296](resources/js/components/ai/CopilotActionsPanel.tsx#L60-L1296), [config/ai_workflows.php#L1-L23](config/ai_workflows.php#L1-L23), [app/Services/Ai/WorkflowService.php#L28-L380](app/Services/Ai/WorkflowService.php#L28-L380)). | No AI coverage for quotes submission, receiving, invoicing, payments, quality, master data, or admin consoles; need new action schemas + converters per module before requirement 1 can be claimed. |
| 2 | "It should be a very interactive and full context Copilot." | ⚠️ Partial | Chat threads stream responses, render draft/workflow previews, and surface quick replies + warnings ([resources/js/components/ai/CopilotChatPanel.tsx#L38-L705](resources/js/components/ai/CopilotChatPanel.tsx#L38-L705)). Workflow panel keeps reviewer state with cursor pagination and optimistic loaders ([resources/js/components/ai/WorkflowPanel.tsx#L131-L1056](resources/js/components/ai/WorkflowPanel.tsx#L131-L1056)). | Context is limited to the active chat thread/workflow; there is no cross-session memory, plan guardrails, or multi-surface sync (e.g., dashboards, forms, or embedded coach marks). Need shared context storage + UI entry points beyond the chat drawer. |
| 3 | "It should know anything and everything in the workspace data." | ⚠️ Partial | Tool resolver only exposes RFQs, quotes, suppliers, inventory stats, and awards ([app/Services/Ai/WorkspaceToolResolver.php#L92-L516](app/Services/Ai/WorkspaceToolResolver.php#L92-L516)), so answers are grounded for sourcing/inventory slices. | No tooling for invoices, receiving, maintenance execution, catalog data, audits, billing, or custom objects. Requirement expects complete workspace visibility; must add resolver coverage + permissions for every module listed in [docs/REQUIREMENTS_FULL.md](docs/REQUIREMENTS_FULL.md). |
| 4 | "Users should be able to interact with it in a friendly conversation also." | ✅ Met (Stage 01 scope) | Chat supports free-form prompts, quick replies, streaming responses, and assistant system notices ([resources/js/components/ai/CopilotChatPanel.tsx#L38-L315](resources/js/components/ai/CopilotChatPanel.tsx#L38-L315), [docs/API_ENVELOPE.md](docs/API_ENVELOPE.md)). | Continue adding sentiment/typing indicators, but baseline conversational UX exists. |
| 5 | "It should help users in decision makings by running forecasts and analytics." | ⚠️ Partial | Forecast and supplier-risk insights ship through `ForecastInsightCard` and `SupplierRiskBadge`, both hitting `AiController` endpoints tied to the AI microservice ([resources/js/components/ai/ForecastInsightCard.tsx](resources/js/components/ai/ForecastInsightCard.tsx), [resources/js/components/ai/SupplierRiskBadge.tsx](resources/js/components/ai/SupplierRiskBadge.tsx), [app/Http/Controllers/Api/V1/AiController.php#L27-L156](app/Http/Controllers/Api/V1/AiController.php#L27-L156)). | Analytics are limited to inventory demand + supplier risk; no RFQ benchmarking, quote win-rate insights, invoice exception predictions, or spend analytics yet. Need broader analytic skill catalog plus UI surfacing inside relevant modules. |
| 6 | "From creating RFQ ... until the end, users should be able to complete the full flow using Copilot alone." | ❌ Not met | Current workflow stops at purchase order drafts ([config/ai_workflows.php#L1-L23](config/ai_workflows.php#L1-L23)); there are no Copilot actions for receiving, invoicing, or payments as required in [docs/REQUIREMENTS_FULL.md](docs/REQUIREMENTS_FULL.md). | Must design workflows/actions for receiving quality, invoice matching, payments, and supplier comms beyond sourcing to satisfy the end-to-end automation goal. |
| 7 | "If Copilot can't complete an action by itself, it should guide the user how they can get that action done by themself." | ❌ Not met | Assistant responses only show `needs_human_review` banners without step-by-step fallbacks ([resources/js/components/ai/CopilotChatPanel.tsx#L118-L205](resources/js/components/ai/CopilotChatPanel.tsx#L118-L205)). | Need dedicated "guided resolution" responses (links to forms, checklists, feature flags) plus contextual documentation tie-ins when an action is unsupported or rejected. |
| 8 | "It should be user guide also." | ⚠️ Partial | `CopilotAnswerPanel` + `CopilotSearchPanel` allow semantic Q&A over documents ([resources/js/components/ai/CopilotAnswerPanel.tsx](resources/js/components/ai/CopilotAnswerPanel.tsx), [resources/js/components/ai/CopilotSearchPanel.tsx](resources/js/components/ai/CopilotSearchPanel.tsx)). | There is no structured in-app guidance (task tours, per-screen tips, entitlement-aware playbooks). Need a knowledge graph + action-aware helper surfaces integrated with Copilot replies. |

## Stage 02 Backlog
- [ ] Seed receiving/invoice tool stubs in [app/Services/Ai/WorkspaceToolResolver.php](app/Services/Ai/WorkspaceToolResolver.php) with placeholder handlers + contract tests; accept when new `workspace.get_receipts` and `workspace.get_invoices` tools return mocked envelopes guarded by tenant scopes.
- [ ] Document “guided resolution” chat response type in [resources/js/components/ai/CopilotChatPanel.tsx](resources/js/components/ai/CopilotChatPanel.tsx) + [resources/js/types/ai-chat.ts](resources/js/types/ai-chat.ts); accept when assistant can render a fallback card linking to a supplied URL with CTA copy.
- [ ] Add workflow template config + converter stubs for `receiving_quality` in [config/ai_workflows.php](config/ai_workflows.php) and [app/Services/Ai/Workflow](app/Services/Ai/Workflow); accept when `phpunit` proves the template registers and `WorkflowService::startWorkflow` persists the extra step.
- [ ] Create semantic search index coverage doc in [docs/AI-ML-Implementation/search-grounding.md](docs/AI-ML-Implementation/search-grounding.md) enumerating missing modules and ownership; accept when doc lists RFQ, PO, receiving, invoice, and contract sources with status tags.
- [ ] Add monitoring dashboard cards for chat/tool errors in [resources/js/components/ai/CopilotChatWidget.tsx](resources/js/components/ai/CopilotChatWidget.tsx) + [app/Http/Controllers/Api/V1/AiChatController.php](app/Http/Controllers/Api/V1/AiChatController.php); accept when rejected drafts + tool failures increment new counters surfaced in the widget header.
