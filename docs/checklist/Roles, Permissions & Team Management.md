Roles, Permissions & Team Management
====================================
Last reviewed: 2024-11-23

## 1. Role & permission inventory
- `config/rbac.php` now defines the canonical permission map for platform, sourcing, suppliers, orders, inventory, billing, the **analytics** domain (`analytics.read|generate`), and the **workspace** domain (notifications, events, exports, global search). These keys are consumed through `App\Support\Permissions\PermissionRegistry` by policies and middleware.
- `config/rbac.php` also adds the tenant-administration permission `tenant.settings.manage`, giving buyer admins/owners a dedicated capability for roster, approvals, and configuration endpoints.
- `database/seeders/RoleTemplateSeeder.php` hydrates every tenant template from `RoleTemplateDefinitions` (`owner`, `buyer_admin`, `buyer_member`, `buyer_requester`, `supplier_admin`, `supplier_estimator`, `finance`, etc.), so fresh installs get the buyer/supplier/finance split expected by the UI.
- Tenant-facing role constants in `resources/js/types/company.ts` match the seeded templates, while platform-only templates remain scoped to the admin console through `AdminGuard` and `User::isPlatformAdmin()`.

**Findings**
1. ~~Permission enforcement is now centralized via `PermissionRegistry`, but a few legacy middlewares still hard-code `user.role` strings (e.g., `BuyerAdminOnly`). These should migrate to permission keys for consistency.~~ âœ… `BuyerAdminOnly` now checks `tenant.settings.manage`, `EnsureCompanyOnboarded` gates incomplete tenants via the same permission, and `EnsureAnalyticsAccess` validates `analytics.*`; continue auditing any remaining guard for direct role checks before future releases.
2. With workspace permissions extracted, future modules must register their scopes under the correct domain instead of depending on ad-hoc role arrays.

## 2. Team management UI/API
- **Implemented:**
	- Invitation drafting UI at `resources/js/pages/settings/company-invitations-page.tsx` covers batch invites, per-role selection, optional expirations/messages, and pending invite management (revoke + stats). The view is gated client-side by `useAuth().isAdmin` or `owner` role and server-side by `buyer_admin_only` middleware plus `StoreCompanyInvitationRequest::authorize()`.
	- Backend flow uses `InviteCompanyUsersAction` and `AcceptCompanyInvitationAction`, persists to `company_invitations`, syncs the `company_user` pivot + `users.role`, and writes audit entries through `AuditLogger`.
	- FX management endpoints (`/api/money/fx`) and money settings requests now rely on `PermissionRegistry` to enforce `billing.write`; the shared `billing_access` middleware also backfills the active company ID from the `company_user` pivot when absent so cross-tenant finance users get the correct permission context.
	- Supplier self-application (`/api/me/apply-supplier`) moved off the legacy `role:owner` middleware; `SupplierApplicationStoreRequest` now checks the dedicated `suppliers.apply` permission and `SupplierApplicationPolicy` relies on `PermissionRegistry`, keeping the owner-only constraint without hard-coded role strings.
- **Missing / gaps:**
	- ~~Settings still lack a roster/role management UI even though `/api/company-members` now exposes list/update/delete endpoints via `App\Http\Controllers\Api\CompanyMemberController`. Owners and buyer admins must hit the API directly to downgrade or remove teammates.~~ âœ… `resources/js/pages/settings/company-members-page.tsx` plus `useCompanyMembers` render the roster with role editing + removal actions, and the page is linked from `/app/settings/team`.
	- ~~Custom ACL editing promised in `/docs/SECURITY_AND_RBAC.md` (per-tenant permission templates) is not surfaced; `RoleTemplateController` only lives under the platform admin namespace and is unusable by tenants.~~ âœ… `/api/company-role-templates` (see `App\Http\Controllers\Api\CompanyRoleTemplateController`) exposes seeded role definitions + permission groups to buyer admins/owners, and `resources/js/pages/settings/company-roles-page.tsx` renders the catalog UI under `/app/settings/roles`.
	- ~~Conflict detection is still missing when a user belongs to multiple companies with different roles; the new `/app/settings/roles` catalog surfaces descriptions, but there is no warning banner or automation to flag mismatched cross-tenant roles.~~ âœ… `/api/company-members` now returns `role_conflict` metadata, and `/app/settings/team` shows destructive alerts + per-user badges whenever a teammate holds mismatched roles across other companies (buyer vs supplier, multiple role mixes), so owners can remediate cross-tenant conflicts without leaving the roster.

## 3. Protected area matrix
| Area | Current guard(s) | Evidence | Result |
| --- | --- | --- | --- |
| RFQs (list/create/update) | `sourcing_access:read|write` middleware + `RfqPolicy` + new supplier invitation checks in `app/Http/Controllers/Api/RFQController.php` | `tests/Feature/Api/RFQAuthorizationTest.php` now covers buyer create/forbidden paths and supplier list/show access (`rfqs.write` required for mutations; invited/open-bidding suppliers can read, others get 404). | **Pass** â€“ buyer admins/requesters only for mutations, suppliers limited to invitations or open bidding as required by `/deep-specs/rfqs.md`.
| RFQ clarifications, awards, attachments | `RfqClarificationPolicy` now enforces invitation + open-bidding access, `RfqClarificationService` mirrors those checks and targets invited suppliers for notifications, `RfqClarificationController` calls the dedicated policy, and `/api/rfqs/{rfq}/clarifications/question` only requires sourcing read access after the route update. | `tests/Feature/Api/RfqClarificationControllerTest.php` covers invited supplier questions/reads, buyer-only answers/amendments, private RFQ denials, and open-bidding supplier flows. | **Pass** â€“ clarifications respect supplier invitations while buyer admins keep exclusive control of answers/amendments per `/deep-specs/rfqs.md`. |
| Quotes & revisions | `QuotePolicy` now routes both buyer and supplier checks through the permission registry (`rfqs.read`), `StoreQuoteRequest` ensures suppliers hold sourcing permissions before submission, and supplier/buyer quote endpoints still flow through `Gate`. | `tests/Feature/Api/QuoteSubmissionTest.php` exercises invitation requirements plus the new "missing sourcing permission" denial, showing suppliers without `rfqs.read` receive 403 while approved roles continue to submit/withdraw. | **Pass** â€“ sourcing permissions govern submit/view/revise/withdraw paths for buyers and suppliers per `/deep-specs/quotes.md`, preventing mis-assigned roles from bypassing quote workflows. |
| Purchase orders | `orders_access:*` middleware + `PurchaseOrderPolicy` + new `ensure.company.approved`/`ensure.subscribed` guards on buyer actions (`routes/api.php` purchase-order group). | `tests/Feature/Api/PurchaseOrderActionsTest.php` covers buyer cancel/export success, cross-company forbidden paths, permission denials, and subscription enforcement responses. | **Pass** â€“ buyer admins with active, approved, subscribed tenants can issue/cancel/export; suppliers remain read-only except acknowledge per `/deep-specs/pos_orders.md`.
| Invoices | `InvoiceController` consistently calls `Gate::authorize` (`viewAny|create|update|delete`) mapped to `InvoicePolicy`; finance role templates now include billing + workspace permissions via `RoleTemplateDefinitions`. | `tests/Feature/Api/InvoiceTest.php` covers finance success (`finance user can create invoiceâ€¦`) plus the new forbidden path (`roles without billing permission cannot create invoices`). | **Pass** â€“ finance/buyer_admin members seeded by `RoleTemplateSeeder` can create/manage invoices, while buyer members lacking billing permissions receive 403 per `/deep-specs/invoicing.md`. |
| Analytics (dashboard + exports) | `EnsureAnalyticsAccess` now enforces both plan entitlements and allowed roles (`owner`, `buyer_admin`, `finance`, `platform_*`). | `app/Http/Middleware/EnsureAnalyticsAccess.php`, routes `Route::get('dashboard/metrics', ...)` and `/api/analytics/*` use this middleware. | **Pass** â€“ supplier roles are denied with `403 Analytics role required` while finance/buyer admins continue to access analytics once the plan flag is enabled.
| Admin console | `/api/admin/*` routes use `admin.guard` which enforces `platform_super|platform_support`. | `routes/api.php` lines 72-120. | **Pass** â€“ platform-only endpoints protected and audited.
| AI features (`POST /api/copilot/analytics`) | Shares the updated `ensure.analytics.access` middleware so analytics role checks apply before plan gating. | `app/Http/Controllers/Api/CopilotController.php`. | **Pass** â€“ supplier-only accounts are denied prior to executing AI queries, keeping analytics results limited to buyer admin/finance/platform users.
| Notifications, events, exports, search | `EnsureNotificationAccess`, `EnsureEventAccess`, `EnsureExportAccess`, and `EnsureSearchAccess` now require the dedicated workspace permissions (`notifications.read/manage`, `events.manage`, `exports.run`, `search.use`) in addition to plan gates. | `tests/Unit/Middleware/WorkspaceAccessMiddlewareTest.php` exercises allowed vs forbidden paths for each middleware (buyer admin/finance succeed, observer role gets 403). | **Pass** â€“ workspace utilities require explicit permissions per `/docs/SECURITY_AND_RBAC.md`, layered on top of subscription entitlements. |

## 4. Endpoints needing guard fixes
1. ~~`app/Http/Controllers/Api/RFQController.php` (all mutating routes) â€“ add policies or `buyer_admin_only` middleware per action so viewers cannot create/update/delete RFQs. Current company-only filter leaks 403 vs 404 inconsistently and allows supplier roles to post buyer RFQs if they share company_id.~~ âœ… Covered by `sourcing_access:write` + `RfqPolicy` and verified through the expanded `tests/Feature/Api/RFQAuthorizationTest.php` suite (buyer-only mutations, invitation-based supplier reads).
2. ~~`app/Http/Controllers/Api/PurchaseOrderController.php@store|send|cancel|createFromAwards` â€“ lacks any `Gate::authorize` or role middleware. Suppliers can cancel buyer POs as long as they match `company_id`. Introduce `PurchaseOrderPolicy` + `Gate` calls and ensure supplier contexts are read-only.~~ âœ… Purchase-order routes now require `auth` plus `ensure.company.onboarded`, `ensure.company.approved`, `ensure.subscribed`, and `orders_access:write` where appropriate (`routes/api.php`), with coverage in `tests/Feature/Api/PurchaseOrderActionsTest.php` (permission + subscription cases).
3. ~~`app/Http/Controllers/Api/RfqInvitationController.php` â€“ route-level middleware ensures buyer admins, but the controller still only checks `company_id` and returns 403 without explaining role mismatch. Should lean on `Gate` for clarity and consistent responses.~~ âœ… Controller + `StoreInvitationRequest` now surface the sourcing write requirement with `rfqs_write_required` error codes, and `tests/Feature/Api/RfqInvitationControllerTest.php` covers buyer admin success plus the buyer-member/supplier-role forbidden paths.
4. ~~`app/Http/Controllers/Api/AnalyticsController.php` & `CopilotController.php` â€“ add role checks (`buyer_admin`, `finance`, analytics-specific role flags) before plan checks, otherwise supplier_estimator accounts can read company spend.~~ âœ… Both controllers now enforce `analytics.read`/`analytics.generate` via `PermissionRegistry`, returning the standardized `analytics_role_required` error, and `tests/Feature/Api/AnalyticsAuthorizationTest.php` covers allowed vs forbidden paths (middleware disabled to prove controller guards).
5. ~~`app/Http/Middleware/EnsureCompanyOnboarded` returns `403` for missing company but does not enforce role readiness; pairing this with the old `role:*` middleware (previously only used for supplier self-apply) would stop cross-role leakage during onboarding.~~ âœ… Middleware now blocks non-owner/buyer_admin roles until onboarding completes, and `tests/Feature/Middleware/EnsureCompanyOnboardedTest.php` covers owner bypass plus member denial scenarios.
6. ~~No API exists to remove company members. Without a DELETE endpoint guarded by `buyer_admin_only`, revoking a compromised user requires direct DB work, which violates `/docs/DEFINITION_OF_DONE.md` security checklist.~~ âœ… `/api/company-members/{member}` now routes to `CompanyMemberController::destroy` behind `buyer_admin_only`, enforces the "at least one owner" rule, reassigns the user to their next tenancy, and emits audit logs. Coverage lives in `tests/Feature/Company/CompanyMemberManagementTest.php` (final-owner denial plus successful removal flow).

## 5. Next steps to consider
1. ~~**Unify role vocabulary:** Continue auditing legacy guards for hard-coded `user.role` checks (e.g., bespoke supplier-only middleware) and migrate them to permission keys so everything routes through `PermissionRegistry`.~~ âœ… Supplier self-application now uses the `suppliers.apply` permission end-to-end, `SupplierApplicationPolicy`/`StoreRequest` rely on `PermissionRegistry`, and the legacy `role:*` middleware has been removed.
2. **Introduce resource policies for RFQs and POs:** mirror the approach taken in `InvoiceController` (centralized `Gate` calls) and add tests that cover success + forbidden paths per `/docs/DEFINITION_OF_DONE.md`.
3. ~~**Build team roster + role management UI:** add `/api/company-members` CRUD endpoints backed by `CompanyUser` pivot, expose them in Settings so owners can remove or downgrade members, and audit all changes.~~ âœ… Completed through the new `/app/settings/team` page, `useCompanyMembers` hooks, and the existing audited API endpoints.
4. ~~**Map permissions to feature middleware:** Replace the remaining ad-hoc role strings inside controllers with permission checks (e.g., `rfqs.write`, `orders.write`, `analytics.read`) so future modules can reuse the ACL without editing policies everywhere.~~ ðŸ”„ Partial â€“ controller work continues, but tenant-facing role descriptions now live at `/app/settings/roles` and pull from `useCompanyRoleTemplates` + `/api/company-role-templates`.
5. ~~**Tighten analytics/copilot RBAC:** require `buyer_admin` or `finance` and log every invocation (already partially done via `CopilotPrompt` audit) while blocking supplier roles even if the plan flag is set.~~ âœ… Completed via the updated `EnsureAnalyticsAccess` middleware + new coverage in `tests/Unit/EnsureAnalyticsAccessTest.php`.