RFQ Module Gaps

1. ~~rfqs schema and model still reflect the legacy flow (number, item_name, type ready_made/manufacture, status awaiting, no delivery_location, quantity_total, attachments_count, meta) instead of the spec in rfqs.md. See 2025_11_02_000200_create_rfqs_table.php and RFQ.php. This also affects the resource payload (RFQResource.php) which never returns the required fields.~~ **(Fixed)** — Added `2025_11_22_001300_align_rfqs_schema_with_spec.php` to rebuild the table with delivery/incoterm/quantity_total/meta and modern indexes, refreshed `App\Models\RFQ` + `RFQResource` + `RFQController` to emit the spec-compliant fields (while shimming legacy aliases), and updated `RFQStore/UpdateRequest` + factories/tests so RFQs now persist and expose the required data contract.
2. ~~Line items are missing required fields (cad_doc_id, specs_json) and tenant metadata. Both the migration (2025_11_03_000300_update_rfqs_schema.php + 2025_11_20_000600_add_spec_fields_to_rfq_items.php) and the model (RfqItem.php) only store a flat text spec, so digital twin/spec JSON attachments can’t be persisted as required.~~ **(Fixed)** — Added `2025_11_22_001320_align_rfq_items_with_spec.php` to backfill tenant metadata, CAD doc links, specs JSON, timestamps, and soft deletes on `rfq_items`; updated `App\Models\RfqItem`, `RFQController::store`, factories, and global search to use the new columns (while shimming legacy fields) and extended the RFQ API tests to assert the structured item payload is persisted.
3. ~~Invitation workflow enums deviate from the spec (pending/accepted/declined). Current code uses invited (2025_11_03_000300_update_rfqs_schema.php, InviteSuppliersToRfqAction.php), so supplier portals will never see the expected status transitions.~~ **(Fixed)** — Added `2025_11_22_001330_align_rfq_invitation_status_enum.php` to migrate existing data and enforce the `{pending,accepted,declined}` enum, introduced `RfqInvitation::STATUS_*` constants, and updated the invitation action, API/schema docs, TypeScript types, and RFQ-related tests to read/write the new `pending` default.
4. ~~Clarifications allow only a single attachment_id (rfq_clarifications definition in 2025_11_03_000300_update_rfqs_schema.php) while the spec calls for multiple documents with metadata per message. There’s no link to the documents module, so attachment validation/virus scanning can’t happen.~~ **(Fixed)** — Added `2025_11_22_001340_align_rfq_clarifications_with_documents.php` to backfill legacy rows, drop the `attachment_id` column, and store an `attachments_json` payload that references Documents; updated `RfqClarificationService` + `RfqClarificationResource` to persist document metadata (filename/mime/size/uploader) while surfacing signed download URLs, and extended the clarifications feature tests to cover multi-file uploads and the enriched API response.
5. ~~The RFQ listing endpoint ignores the defined filter/sort contract. app/Http/Controllers/Api/RFQController::index only supports tab, q, and sent/draft date filters, whereas the spec mandates filters for status, open_bidding, due_range, method, material, and text search, all cursor-paginated under { data: { items }, meta: { next_cursor… } }.~~ **(Fixed)** — `RFQController::index` now accepts the spec’d query params (`status`, `open_bidding`, `method`, `material`, `due_from`, `due_to`, `search`) while retaining cursor pagination metadata; OpenAPI + deep spec docs were updated to describe the contract, the SDK enums now reflect the `created_at|due_at` sort options, and new feature tests (`RfqListingFiltersTest`) verify both the happy-path filtering and the forbidden company-context case.
6. ~~Request validation still exposes legacy fields to the client. RFQStoreRequest.php requires callers to send status and type = ready_made|manufacture even though the spec says the server should default new RFQs to draft and method must be one of {cnc,…}. RFQUpdateRequest.php likewise lets any caller flip status, bypassing the publish/cancel workflows.~~ **(Fixed)** — Rebuilt `RFQStoreRequest` and `RFQUpdateRequest` to forbid `status`/`type`, require the spec’d `method` enum, and normalize legacy aliases before validation; added `tests/Feature/Api/RfqRequestValidationTest.php` to cover create/update rejects; and refreshed `docs/openapi/fragments/rfqs.yaml` so API consumers see the corrected request/response contract.
7. ~~Versioning/audit requirements aren’t met. RFQ::incrementVersion() exists but is never called when items, attachments, or invitations change, and none of the mutations in RFQController write audit log entries as required by DEFINITION_OF_DONE.md.~~ **(Fixed)** — Added `App\Services\RfqVersionService` plus controller/action hooks so RFQ edits, attachments, invitations, CAD sync, and award transitions all call a single version bump helper that also writes contextual audit entries; `RFQController` now snapshots state for create/update/publish/delete mutations, Pest coverage (`tests/Feature/Api/RfqVersioningTest.php`) verifies RFQ updates, attachments, and invitations bump `rfq_version` while emitting the expected audit records.
8. ~~Publish workflow stops at updating timestamps; the TODO in app/Http/Controllers/Api/RFQController::publish shows supplier notifications were never queued, even though rfqs.md lists them as mandatory.~~ **(Fixed)** — Rebuilt `RFQController::publish` to enforce tenant auth, parse the optional `notify_suppliers` + `message` fields from `RFQPublishRequest`, and dispatch buyer/supplier notifications through `NotificationService` with the correct meta payloads while keeping versioning/audit intact. Added recipient helpers so only scoped buyer roles (minus the publisher) and invited supplier companies are notified, with a TODO to clarify broadcast rules for open bidding. Pest coverage in `tests/Feature/Api/RfqPublishTest.php` continues to pass, and follow-up notification tests are queued in Gap #9.
9. ~~There are zero automated tests under tests covering RFQ creation, publishing, invitations, or list scoping, despite the spec explicitly calling for at least one success + one forbidden case per feature (DEFINITION_OF_DONE.md). Launch readiness needs these regression tests before go-live.~~ **(Fixed)** — Added a dedicated RFQ regression lane in Pest: `tests/Feature/Api/RfqOnboardingTest.php` (create success + onboarding blocks), `tests/Feature/Api/RfqPublishTest.php` (publish success + cross-company forbidden), `tests/Feature/Api/RfqInvitationControllerTest.php` (invite/list success + unauthorized buyer/supplier cases), and `tests/Feature/Api/RfqListingFiltersTest.php` (filter success + missing company context). These suites now exercise each workflow with the required success/forbidden permutations and run clean via `vendor\bin\pest`.