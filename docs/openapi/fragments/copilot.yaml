paths:
  /api/copilot/analytics:
    post:
      tags:
        - Copilot
      summary: Generate analytics insight via Copilot
      operationId: copilotAnalytics
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              additionalProperties: true
      responses:
        '200':
          description: Analytics insight with supporting narrative.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiSuccessResponse'
  /api/copilot/chat/completions:
    post:
      tags:
        - Copilot
      summary: Stream structured copilot response
      operationId: copilotChatCompletion
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              additionalProperties: true
      responses:
        '200':
          description: Copilot generated completion payload.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiSuccessResponse'
  /api/copilot/search:
    post:
      tags:
        - Copilot
      summary: Run semantic search across indexed tenant documents
      operationId: copilotSemanticSearch
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CopilotQueryRequest'
      responses:
        '200':
          description: Ranked document chunks matching the supplied query.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiSuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/CopilotSearchResult'
  /api/copilot/answer:
    post:
      tags:
        - Copilot
      summary: Generate grounded answers with citations
      operationId: copilotAnswer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CopilotQueryRequest'
      responses:
        '200':
          description: Answer assembled from the top semantic search hits plus citations.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiSuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/CopilotAnswerResult'
  /api/copilot/prompts:
    get:
      tags:
        - Copilot
      summary: List available copilot prompts
      operationId: listCopilotPrompts
      responses:
        '200':
          description: Copilot prompt catalog.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiSuccessResponse'
  /api/v1/ai/actions/plan:
    post:
      tags:
        - Copilot
      summary: Generate a Copilot action draft
      description: Invokes the AI planning service to produce a draft action payload scoped to the tenant context.
      operationId: copilotActionPlan
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CopilotActionPlanRequest'
      responses:
        '200':
          description: Copilot action draft generated successfully.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiSuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        required:
                          - draft
                        properties:
                          draft:
                            $ref: '#/components/schemas/CopilotActionDraft'
        '403':
          description: User is not authorized to run the requested Copilot action.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
        '422':
          description: Validation failed for the supplied action payload.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
        '502':
          description: Copilot failed to generate a draft from the upstream AI service.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
        '503':
          description: AI service temporarily unavailable.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
  /api/v1/ai/actions/{draft}/approve:
    post:
      tags:
        - Copilot
      summary: Approve a Copilot action draft
      description: Marks the draft as approved and converts it into the downstream entity defined by the draft payload.
      operationId: copilotActionApprove
      parameters:
        - name: draft
          in: path
          required: true
          description: Identifier of the draft to approve.
          schema:
            type: integer
            minimum: 1
      responses:
        '200':
          description: Draft approved and converted successfully.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiSuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        required:
                          - draft
                        properties:
                          draft:
                            $ref: '#/components/schemas/CopilotActionDraft'
        '403':
          description: User cannot approve this Copilot action.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
        '404':
          description: Draft not found for the tenant.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
        '422':
          description: Draft is no longer in a state that can be approved or payload conversion failed validation.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
        '500':
          description: Copilot failed to finalize the draft due to an internal error.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
  /api/v1/ai/actions/{draft}/reject:
    post:
      tags:
        - Copilot
      summary: Reject a Copilot action draft
      operationId: copilotActionReject
      parameters:
        - name: draft
          in: path
          required: true
          description: Identifier of the draft to reject.
          schema:
            type: integer
            minimum: 1
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CopilotActionRejectRequest'
      responses:
        '200':
          description: Draft rejected successfully.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiSuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        required:
                          - draft
                        properties:
                          draft:
                            $ref: '#/components/schemas/CopilotActionDraft'
        '403':
          description: User cannot reject this Copilot action.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
        '404':
          description: Draft not found.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
        '422':
          description: Draft already resolved or validation failed.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
  /api/v1/ai/actions/{draft}/feedback:
    post:
      tags:
        - Copilot
      summary: Record feedback for a Copilot action draft
      operationId: copilotActionFeedback
      parameters:
        - name: draft
          in: path
          required: true
          description: Identifier of the draft receiving feedback.
          schema:
            type: integer
            minimum: 1
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CopilotActionFeedbackRequest'
      responses:
        '200':
          description: Feedback captured successfully.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiSuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        required:
                          - feedback
                        properties:
                          feedback:
                            $ref: '#/components/schemas/CopilotActionFeedback'
        '403':
          description: User cannot review this Copilot action.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
        '404':
          description: Draft not found.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
        '422':
          description: Feedback payload invalid.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
  /api/v1/ai/admin/usage-metrics:
    get:
      tags:
        - Copilot
      summary: Retrieve AI admin usage metrics
      description: Aggregates feature-level AI adoption metrics for the authenticated tenant or selected company.
      operationId: getAiAdminUsageMetrics
      responses:
        '200':
          description: Aggregated AI usage metrics for the trailing window.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiSuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        required:
                          - metrics
                        properties:
                          metrics:
                            $ref: '#/components/schemas/AiUsageMetrics'
        '403':
          description: User lacks AI admin permissions or feature gating blocks access.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
  /api/v1/ai/chat/threads:
    get:
      tags:
        - Copilot
      summary: List Copilot chat threads
      operationId: listAiChatThreads
      parameters:
        - $ref: '#/components/parameters/CursorQuery'
        - $ref: '#/components/parameters/PerPageQuery'
        - name: status
          in: query
          required: false
          description: >-
            Optional filter accepting comma-separated values or repeated query
            keys. Supported values are `open` and `closed`.
          schema:
            type: array
            items:
              $ref: '#/components/schemas/AiChatThreadStatus'
          style: form
          explode: false
      responses:
        '200':
          description: Cursor-paginated list of chat threads ordered by activity.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiSuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        required:
                          - items
                        properties:
                          items:
                            type: array
                            items:
                              $ref: '#/components/schemas/AiChatThread'
        '403':
          description: Chat access is disabled for this user or plan.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
    post:
      tags:
        - Copilot
      summary: Create a new Copilot chat thread
      operationId: createAiChatThread
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AiChatCreateThreadRequest'
      responses:
        '200':
          description: Chat thread created successfully.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiSuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        required:
                          - thread
                        properties:
                          thread:
                            $ref: '#/components/schemas/AiChatThread'
        '403':
          description: Chat access is disabled for this user or plan.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
  /api/v1/ai/chat/threads/{thread}:
    get:
      tags:
        - Copilot
      summary: Fetch a chat thread with recent messages
      operationId: showAiChatThread
      parameters:
        - name: thread
          in: path
          required: true
          schema:
            type: integer
            minimum: 1
        - name: limit
          in: query
          required: false
          description: Maximum number of recent messages to include (1-100).
          schema:
            type: integer
            minimum: 1
            maximum: 100
      responses:
        '200':
          description: Thread details plus the latest conversation history.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiSuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        required:
                          - thread
                        properties:
                          thread:
                            $ref: '#/components/schemas/AiChatThread'
        '403':
          description: Chat access is disabled for this user or plan.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
        '404':
          description: Thread not found for the tenant.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
  /api/v1/ai/chat/threads/{thread}/send:
    post:
      tags:
        - Copilot
      summary: Send a message to Copilot chat
      operationId: sendAiChatMessage
      parameters:
        - name: thread
          in: path
          required: true
          schema:
            type: integer
            minimum: 1
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AiChatSendMessageRequest'
      responses:
        '200':
          description: >-
            Message accepted. When `stream=true` the response contains a stream
            token; otherwise the final assistant message and response payload are
            returned immediately.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiSuccessResponse'
                  - type: object
                    properties:
                      data:
                        oneOf:
                          - $ref: '#/components/schemas/AiChatSendMessageResult'
                          - $ref: '#/components/schemas/AiChatStreamSession'
        '403':
          description: Chat access is disabled for this user or plan.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
        '404':
          description: Thread not found for the tenant.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
        '422':
          description: Validation failed for the chat payload.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
        '502':
          description: Upstream AI service returned an error.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
        '503':
          description: AI service temporarily unavailable.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
  /api/v1/ai/chat/threads/{thread}/stream:
    get:
      tags:
        - Copilot
      summary: Stream Copilot chat responses via Server-Sent Events
      operationId: streamAiChatThread
      parameters:
        - name: thread
          in: path
          required: true
          schema:
            type: integer
            minimum: 1
        - name: token
          in: query
          required: true
          description: Stream token issued by the `send` endpoint when `stream=true`.
          schema:
            type: string
      responses:
        '200':
          description: SSE channel emitting `start`, `delta`, `tool`, `complete`, and `final` events.
          content:
            text/event-stream:
              schema:
                type: string
              examples:
                delta:
                  summary: Streaming delta frame
                  value: |-
                    event: delta
                    data: {"text":"Answer chunk"}
        '400':
          description: Stream token missing or invalid.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
        '403':
          description: Chat access is disabled for this user or plan.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
        '404':
          description: Thread not found for the tenant.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
  /api/v1/ai/chat/threads/{thread}/tools/resolve:
    post:
      tags:
        - Copilot
      summary: Resolve workspace tool calls requested by Copilot
      operationId: resolveAiChatTools
      parameters:
        - name: thread
          in: path
          required: true
          schema:
            type: integer
            minimum: 1
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AiChatResolveToolsRequest'
      responses:
        '200':
          description: Tool results stored and final assistant response generated.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiSuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/AiChatToolResolveResult'
        '403':
          description: Chat access is disabled for this user or plan.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
        '404':
          description: Thread not found for the tenant.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
        '422':
          description: Validation failed for the requested tool calls.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
        '502':
          description: Upstream AI service returned an error.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
        '503':
          description: AI service temporarily unavailable.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
  /api/v1/ai/drafts/{draft}/approve:
    post:
      tags:
        - Copilot
      summary: Approve a Copilot action draft (alias)
      description: Alias for `/api/v1/ai/actions/{draft}/approve` to support legacy clients.
      operationId: copilotActionApproveAlias
      parameters:
        - name: draft
          in: path
          required: true
          schema:
            type: integer
            minimum: 1
      responses:
        '200':
          description: Draft approved and converted successfully.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiSuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        required:
                          - draft
                        properties:
                          draft:
                            $ref: '#/components/schemas/CopilotActionDraft'
        '403':
          description: User cannot approve this Copilot action.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
        '404':
          description: Draft not found for the tenant.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
        '422':
          description: Draft is no longer in a state that can be approved or payload conversion failed validation.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
        '500':
          description: Copilot failed to finalize the draft due to an internal error.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
  /api/v1/ai/drafts/{draft}/reject:
    post:
      tags:
        - Copilot
      summary: Reject a Copilot action draft (alias)
      description: Alias for `/api/v1/ai/actions/{draft}/reject` to support legacy clients.
      operationId: copilotActionRejectAlias
      parameters:
        - name: draft
          in: path
          required: true
          schema:
            type: integer
            minimum: 1
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CopilotActionRejectRequest'
      responses:
        '200':
          description: Draft rejected successfully.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiSuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        required:
                          - draft
                        properties:
                          draft:
                            $ref: '#/components/schemas/CopilotActionDraft'
        '403':
          description: User cannot reject this Copilot action.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
        '404':
          description: Draft not found.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
        '422':
          description: Draft already resolved or validation failed.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
  /api/v1/ai/workflows:
    get:
      tags:
        - Copilot
      summary: List AI workflows for the tenant
      operationId: listAiWorkflows
      parameters:
        - $ref: '#/components/parameters/CursorQuery'
        - $ref: '#/components/parameters/PerPageQuery'
        - name: status
          in: query
          required: false
          description: Filter workflows by status. Accepts comma-separated values or repeated query keys.
          schema:
            type: array
            items:
              $ref: '#/components/schemas/AiWorkflowStatus'
          style: form
          explode: false
        - name: workflow_type
          in: query
          required: false
          schema:
            type: string
          description: Optional workflow template identifier.
      responses:
        '200':
          description: Cursor-paginated workflow collection.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiSuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        required:
                          - items
                        properties:
                          items:
                            type: array
                            items:
                              $ref: '#/components/schemas/AiWorkflow'
        '403':
          description: Workflow access is disabled for this user or plan.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
  /api/v1/ai/workflows/start:
    post:
      tags:
        - Copilot
      summary: Start a Copilot workflow from a chat thread or workspace context
      operationId: startAiWorkflow
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AiWorkflowStartRequest'
      responses:
        '200':
          description: Workflow planned successfully.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiSuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        required:
                          - workflow_id
                        properties:
                          workflow_id:
                            type: string
        '403':
          description: Workflow access is disabled for this user or plan.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
        '404':
          description: Referenced chat thread not found.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
        '422':
          description: Validation failed for the workflow payload.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
        '502':
          description: Upstream AI service returned an error.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
        '503':
          description: AI service temporarily unavailable.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
  /api/v1/ai/workflows/{workflow}/next:
    get:
      tags:
        - Copilot
      summary: Draft the next step for a workflow
      operationId: nextAiWorkflowStep
      parameters:
        - name: workflow
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Returns the workflow and the drafted step when available.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiSuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          workflow:
                            $ref: '#/components/schemas/AiWorkflow'
                          step:
                            oneOf:
                              - $ref: '#/components/schemas/AiWorkflowStep'
                              - type: 'null'
        '403':
          description: Workflow access is disabled for this user or plan.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
        '404':
          description: Workflow not found for the tenant.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
        '502':
          description: Upstream AI service returned an error.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
        '503':
          description: AI service temporarily unavailable.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
  /api/v1/ai/workflows/{workflow}/events:
    get:
      tags:
        - Copilot
      summary: List workflow audit events
      operationId: listAiWorkflowEvents
      parameters:
        - name: workflow
          in: path
          required: true
          schema:
            type: string
        - $ref: '#/components/parameters/CursorQuery'
        - $ref: '#/components/parameters/PerPageQuery'
      responses:
        '200':
          description: Cursor-paginated workflow event feed.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiSuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        required:
                          - items
                        properties:
                          items:
                            type: array
                            items:
                              $ref: '#/components/schemas/AiWorkflowEvent'
        '403':
          description: Workflow access is disabled for this user or plan.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
        '404':
          description: Workflow not found for the tenant.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
  /api/v1/ai/workflows/{workflow}/complete:
    post:
      tags:
        - Copilot
      summary: Approve or reject the current workflow step
      operationId: completeAiWorkflowStep
      parameters:
        - name: workflow
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AiWorkflowCompleteRequest'
      responses:
        '200':
          description: Workflow step resolved and optionally advanced.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiSuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          workflow:
                            $ref: '#/components/schemas/AiWorkflow'
                          step:
                            $ref: '#/components/schemas/AiWorkflowStep'
                          next_step:
                            oneOf:
                              - $ref: '#/components/schemas/AiWorkflowStep'
                              - type: 'null'
        '403':
          description: User cannot resolve the workflow step.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
        '404':
          description: Workflow or step not found.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
        '422':
          description: Workflow step already resolved.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
        '502':
          description: Upstream AI service returned an error.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
        '503':
          description: AI service temporarily unavailable.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'

components:
  schemas:
    AiChatThreadStatus:
      type: string
      enum:
        - open
        - closed
    AiChatThread:
      type: object
      required:
        - id
        - status
        - user_id
        - metadata
        - created_at
        - updated_at
      properties:
        id:
          type: integer
        title:
          type: string
          nullable: true
        status:
          $ref: '#/components/schemas/AiChatThreadStatus'
        user_id:
          type: integer
        last_message_at:
          type: string
          format: date-time
          nullable: true
        metadata:
          type: object
          additionalProperties: true
        thread_summary:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        messages:
          type: array
          nullable: true
          items:
            $ref: '#/components/schemas/AiChatMessage'
    AiChatAttachment:
      type: object
      additionalProperties: true
      description: Arbitrary attachment metadata captured by the client.
    AiChatMessage:
      type: object
      required:
        - id
        - thread_id
        - role
        - status
        - created_at
      properties:
        id:
          type: integer
        thread_id:
          type: integer
        user_id:
          type: integer
          nullable: true
        role:
          type: string
          enum:
            - user
            - assistant
            - system
            - tool
        content_text:
          type: string
          nullable: true
        content:
          type: object
          nullable: true
          additionalProperties: true
        citations:
          type: array
          items:
            $ref: '#/components/schemas/CopilotCitation'
        tool_calls:
          type: array
          items:
            $ref: '#/components/schemas/AiChatToolCall'
        tool_results:
          type: array
          items:
            $ref: '#/components/schemas/AiChatToolResult'
        latency_ms:
          type: integer
          nullable: true
        status:
          type: string
          enum:
            - pending
            - completed
            - failed
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    AiChatMessageContext:
      type: object
      properties:
        context:
          type: object
          additionalProperties: true
          description: Domain-specific context supplied by the UI.
        ui_mode:
          type: string
          maxLength: 50
        locale:
          type: string
          maxLength: 10
          description: Preferred language tag (BCP 47) used when requesting localized help guides.
        attachments:
          type: array
          items:
            $ref: '#/components/schemas/AiChatAttachment'
      additionalProperties: false
    AiChatCreateThreadRequest:
      type: object
      properties:
        title:
          type: string
          maxLength: 255
          nullable: true
    AiChatSendMessageRequest:
      type: object
      required:
        - message
      properties:
        message:
          type: string
          maxLength: 4000
        context:
          $ref: '#/components/schemas/AiChatMessageContext'
        ui_mode:
          type: string
          maxLength: 50
          nullable: true
        attachments:
          type: array
          items:
            $ref: '#/components/schemas/AiChatAttachment'
        stream:
          type: boolean
          description: When true, the endpoint returns a stream token for SSE consumption.
    AiChatToolCall:
      type: object
      required:
        - tool_name
        - call_id
      properties:
        tool_name:
          type: string
          enum:
            - workspace.search_rfqs
            - workspace.get_rfq
            - workspace.list_suppliers
            - workspace.get_quotes_for_rfq
            - workspace.get_inventory_item
            - workspace.low_stock
            - workspace.get_awards
            - workspace.get_receipts
            - workspace.get_invoices
            - workspace.award_quote
            - workspace.invoice_draft
            - workspace.approve_invoice
            - workspace.review_rfq
            - workspace.review_quote
            - workspace.review_po
            - workspace.review_invoice
        call_id:
          type: string
          maxLength: 128
        arguments:
          type: object
          nullable: true
          additionalProperties: true
    AiChatToolResult:
      type: object
      required:
        - tool_name
        - call_id
      properties:
        tool_name:
          type: string
        call_id:
          type: string
        result:
          type: object
          nullable: true
          additionalProperties: true
    AiChatResolveToolsRequest:
      type: object
      required:
        - tool_calls
      properties:
        tool_calls:
          type: array
          minItems: 1
          maxItems: 5
          items:
            $ref: '#/components/schemas/AiChatToolCall'
        context:
          $ref: '#/components/schemas/AiChatMessageContext'
    AiChatWorkflowStep:
      type: object
      required:
        - title
        - summary
      properties:
        title:
          type: string
        summary:
          type: string
        payload:
          type: object
          additionalProperties: true
          description: Structured metadata describing how to execute the step.
    AiChatWorkflowSuggestion:
      type: object
      required:
        - workflow_type
        - steps
        - payload
      properties:
        workflow_type:
          type: string
        steps:
          type: array
          items:
            $ref: '#/components/schemas/AiChatWorkflowStep'
        payload:
          type: object
          additionalProperties: true
    AiChatGuidedResolution:
      type: object
      required:
        - title
        - description
        - cta_label
      properties:
        title:
          type: string
        description:
          type: string
        cta_label:
          type: string
        cta_url:
          type: string
          format: uri
          nullable: true
        locale:
          type: string
          maxLength: 10
          description: Language used to render the help content.
        available_locales:
          type: array
          description: Language codes Copilot can serve for this guide.
          items:
            type: string
            maxLength: 10
    AiChatDraftAction:
      type: object
      required:
        - action_type
        - summary
        - payload
        - citations
        - confidence
        - needs_human_review
        - warnings
      properties:
        action_type:
          type: string
        summary:
          type: string
        payload:
          type: object
          additionalProperties: true
        citations:
          type: array
          items:
            $ref: '#/components/schemas/CopilotCitation'
        confidence:
          type: number
          format: float
        needs_human_review:
          type: boolean
        warnings:
          type: array
          items:
            type: string
        draft_id:
          type: integer
          nullable: true
        status:
          type: string
          nullable: true
    AiChatResponse:
      type: object
      required:
        - type
        - assistant_message_markdown
        - citations
        - suggested_quick_replies
        - needs_human_review
        - confidence
        - warnings
      properties:
        type:
          type: string
          enum:
            - answer
            - draft_action
            - workflow_suggestion
            - guided_resolution
            - tool_request
            - review_rfq
            - review_quote
            - review_po
            - review_invoice
            - analytics
            - forecast_spend
            - forecast_supplier_performance
            - forecast_inventory
            - error
        assistant_message_markdown:
          type: string
        citations:
          type: array
          items:
            $ref: '#/components/schemas/CopilotCitation'
        suggested_quick_replies:
          type: array
          items:
            type: string
        draft:
          oneOf:
            - $ref: '#/components/schemas/AiChatDraftAction'
            - type: 'null'
        workflow:
          oneOf:
            - $ref: '#/components/schemas/AiChatWorkflowSuggestion'
            - type: 'null'
        guided_resolution:
          oneOf:
            - $ref: '#/components/schemas/AiChatGuidedResolution'
            - type: 'null'
          description: Localized help metadata surfaced when Copilot cannot automate the requested task.
        tool_calls:
          type: array
          nullable: true
          items:
            $ref: '#/components/schemas/AiChatToolCall'
        tool_results:
          type: array
          nullable: true
          items:
            $ref: '#/components/schemas/AiChatToolResult'
        needs_human_review:
          type: boolean
        confidence:
          type: number
          format: float
        warnings:
          type: array
          items:
            type: string
        review:
          type: object
          nullable: true
          additionalProperties: true
          description: Structured checklist payload for review_* responses.
    AiChatSendMessageResult:
      type: object
      required:
        - user_message
        - assistant_message
        - response
      properties:
        user_message:
          $ref: '#/components/schemas/AiChatMessage'
        assistant_message:
          $ref: '#/components/schemas/AiChatMessage'
        response:
          $ref: '#/components/schemas/AiChatResponse'
    AiChatStreamSession:
      type: object
      required:
        - user_message
        - stream_token
        - expires_in
      properties:
        user_message:
          $ref: '#/components/schemas/AiChatMessage'
        stream_token:
          type: string
        expires_in:
          type: integer
          description: Lifetime of the stream token in seconds.
    AiChatToolResolveResult:
      type: object
      required:
        - tool_message
        - assistant_message
        - response
      properties:
        tool_message:
          $ref: '#/components/schemas/AiChatMessage'
        assistant_message:
          $ref: '#/components/schemas/AiChatMessage'
        response:
          $ref: '#/components/schemas/AiChatResponse'
    AiWorkflowStatus:
      type: string
      enum:
        - pending
        - in_progress
        - completed
        - failed
        - rejected
        - aborted
    AiWorkflowStepSummary:
      type: object
      properties:
        step_index:
          type: integer
          nullable: true
        action_type:
          type: string
          nullable: true
        approval_status:
          type: string
          nullable: true
        name:
          type: string
          nullable: true
    AiWorkflow:
      type: object
      required:
        - workflow_id
        - workflow_type
        - status
        - steps
      properties:
        workflow_id:
          type: string
        workflow_type:
          type: string
        status:
          $ref: '#/components/schemas/AiWorkflowStatus'
        current_step:
          type: integer
          nullable: true
        last_event_type:
          type: string
          nullable: true
        last_event_time:
          type: string
          format: date-time
          nullable: true
        steps:
          type: array
          items:
            $ref: '#/components/schemas/AiWorkflowStepSummary'
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    AiWorkflowStep:
      type: object
      required:
        - workflow_id
        - step_index
        - action_type
        - approval_status
      properties:
        workflow_id:
          type: string
        step_index:
          type: integer
        name:
          type: string
          nullable: true
        action_type:
          type: string
        inputs:
          type: object
          additionalProperties: true
        draft:
          type: object
          additionalProperties: true
        output:
          type: object
          additionalProperties: true
        approval_status:
          type: string
          enum:
            - pending
            - approved
            - rejected
        approved_by:
          type: integer
          nullable: true
        approved_at:
          type: string
          format: date-time
          nullable: true
        updated_at:
          type: string
          format: date-time
    AiWorkflowEvent:
      type: object
      required:
        - event
        - status
        - timestamp
      properties:
        event:
          type: string
        status:
          type: string
        message:
          type: string
          nullable: true
        latency_ms:
          type: integer
          nullable: true
        timestamp:
          type: string
          format: date-time
        workflow:
          type: object
          additionalProperties: true
        payload:
          type: object
          nullable: true
          additionalProperties: true
        user:
          type: object
          nullable: true
          properties:
            id:
              type: integer
              nullable: true
            name:
              type: string
              nullable: true
            email:
              type: string
              nullable: true
    AiWorkflowStartRequest:
      type: object
      required:
        - workflow_type
      properties:
        workflow_type:
          type: string
        rfq_id:
          type: string
          maxLength: 64
          nullable: true
        goal:
          type: string
          maxLength: 2000
          nullable: true
        inputs:
          type: object
          additionalProperties: true
        user_context:
          type: object
          additionalProperties: true
        thread_id:
          type: integer
          minimum: 1
          nullable: true
    AiWorkflowCompleteRequest:
      type: object
      required:
        - step_index
        - approval
      properties:
        step_index:
          type: integer
          minimum: 0
        approval:
          type: boolean
        output:
          type: object
          additionalProperties: true
        notes:
          type: string
          maxLength: 2000
          nullable: true
    AiUsageMetrics:
      type: object
      required:
        - window_days
        - window_start
        - window_end
        - actions
        - forecasts
        - help_requests
        - tool_errors
      properties:
        window_days:
          type: integer
          minimum: 1
        window_start:
          type: string
          format: date-time
        window_end:
          type: string
          format: date-time
        actions:
          $ref: '#/components/schemas/AiUsageActionMetrics'
        forecasts:
          $ref: '#/components/schemas/AiUsageForecastMetrics'
        help_requests:
          $ref: '#/components/schemas/AiUsageHelpMetrics'
        tool_errors:
          $ref: '#/components/schemas/AiUsageToolErrorMetrics'
    AiUsageActionMetrics:
      type: object
      required:
        - planned
        - approved
        - approval_rate
      properties:
        planned:
          type: integer
          minimum: 0
        approved:
          type: integer
          minimum: 0
        approval_rate:
          type: number
          format: float
          nullable: true
          description: Percentage of planned Copilot drafts that were approved in the trailing window.
    AiUsageForecastMetrics:
      type: object
      required:
        - generated
        - errors
      properties:
        generated:
          type: integer
          minimum: 0
        errors:
          type: integer
          minimum: 0
    AiUsageHelpMetrics:
      type: object
      required:
        - total
      properties:
        total:
          type: integer
          minimum: 0
    AiUsageToolErrorMetrics:
      type: object
      required:
        - total
        - by_feature
      properties:
        total:
          type: integer
          minimum: 0
        by_feature:
          type: array
          items:
            $ref: '#/components/schemas/AiUsageToolErrorBreakdown'
    AiUsageToolErrorBreakdown:
      type: object
      required:
        - feature
        - count
      properties:
        feature:
          type: string
        count:
          type: integer
          minimum: 0
