components:
    schemas:
        CreditNote:
            type: object
            required:
                - id
                - company_id
                - invoice_id
                - credit_number
                - status
                - amount
                - amount_minor
                - currency
            properties:
                id:
                    type: string
                    format: uuid
                company_id:
                    type: integer
                invoice_id:
                    type: integer
                purchase_order_id:
                    type: integer
                    nullable: true
                grn_id:
                    type: integer
                    nullable: true
                credit_number:
                    type: string
                currency:
                    type: string
                amount:
                    type: string
                amount_minor:
                    type: integer
                reason:
                    type: string
                status:
                    type: string
                    enum: [draft, pending_review, issued, approved, rejected]
                review_comment:
                    type: string
                    nullable: true
                issued_by:
                    type: integer
                    nullable: true
                approved_by:
                    type: integer
                    nullable: true
                approved_at:
                    type: string
                    format: date-time
                    nullable: true
                attachments:
                    type: array
                    items:
                        $ref: '#/components/schemas/DocumentAttachment'
                lines:
                    type: array
                    items:
                        $ref: '#/components/schemas/CreditNoteLine'
                invoice:
                    type: object
                    nullable: true
                    properties:
                        id:
                            type: string
                            format: uuid
                        invoice_number:
                            type: string
                purchase_order:
                    type: object
                    nullable: true
                    properties:
                        id:
                            type: integer
                        po_number:
                            type: string
                goods_receipt_note:
                    type: object
                    nullable: true
                    properties:
                        id:
                            type: integer
                        number:
                            type: string
                created_at:
                    type: string
                    format: date-time
                updated_at:
                    type: string
                    format: date-time
        CreditNoteLine:
            type: object
            required:
                - id
                - invoice_line_id
                - qty_invoiced
                - qty_to_credit
                - unit_price_minor
                - currency
            properties:
                id:
                    type: integer
                invoice_line_id:
                    type: integer
                description:
                    type: string
                    nullable: true
                qty_invoiced:
                    type: number
                qty_to_credit:
                    type: number
                qty_already_credited:
                    type: number
                    nullable: true
                unit_price_minor:
                    type: integer
                currency:
                    type: string
                uom:
                    type: string
                    nullable: true
                total_minor:
                    type: integer
        CreditNoteCollection:
            type: object
            required:
                - items
                - meta
            properties:
                items:
                    type: array
                    items:
                        $ref: '#/components/schemas/CreditNote'
                meta:
                    $ref: '#/components/schemas/PageMeta'
paths:
    /api/credit-notes:
        get:
            tags:
                - Credit Notes
            summary: List credit notes for tenant
            operationId: listCreditNotes
            parameters:
                - $ref: '#/components/parameters/PageQuery'
                - $ref: '#/components/parameters/PerPageQuery'
                - name: status
                  in: query
                  schema:
                      type: string
                      enum: [draft, pending_review, issued, approved, rejected]
                - name: invoice_id
                  in: query
                  schema:
                      type: integer
                - name: created_from
                  in: query
                  schema:
                      type: string
                      format: date
                - name: created_to
                  in: query
                  schema:
                      type: string
                      format: date
            responses:
                '200':
                    description: Paginated credit notes scoped to the current company.
                    content:
                        application/json:
                            schema:
                                allOf:
                                    - $ref: '#/components/schemas/ApiSuccessResponse'
                                    - type: object
                                      properties:
                                          data:
                                              $ref: '#/components/schemas/CreditNoteCollection'
    /api/credit-notes/invoices/{invoiceId}:
        post:
            tags:
                - Credit Notes
            summary: Draft credit note from invoice
            operationId: createCreditNote
            parameters:
                - name: invoiceId
                  in: path
                  required: true
                  schema:
                      type: string
                      format: uuid
            requestBody:
                required: true
                content:
                    multipart/form-data:
                        schema:
                            type: object
                            required:
                                - reason
                                - amount_minor
                            properties:
                                reason:
                                    type: string
                                amount_minor:
                                    type: integer
                                attachments:
                                    type: array
                                    items:
                                        type: string
                                        format: binary
            responses:
                '201':
                    description: Credit note created in draft state.
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/ApiSuccessResponse'
    /api/credit-notes/{creditNoteId}:
        parameters:
            - name: creditNoteId
              in: path
              required: true
              schema:
                  type: string
                  format: uuid
        get:
            tags:
                - Credit Notes
            summary: Retrieve credit note
            operationId: showCreditNote
            responses:
                '200':
                    description: Credit note detail with invoice linkage.
                    content:
                        application/json:
                            schema:
                                allOf:
                                    - $ref: '#/components/schemas/ApiSuccessResponse'
                                    - type: object
                                      properties:
                                          data:
                                              $ref: '#/components/schemas/CreditNote'
    /api/credit-notes/{creditNoteId}/issue:
        post:
            tags:
                - Credit Notes
            summary: Issue credit note to supplier
            operationId: issueCreditNote
            parameters:
                - name: creditNoteId
                  in: path
                  required: true
                  schema:
                      type: string
                      format: uuid
            responses:
                '200':
                    description: Credit note marked as issued.
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/ApiSuccessResponse'
    /api/credit-notes/{creditNoteId}/approve:
        post:
            tags:
                - Credit Notes
            summary: Approve or reject credit note
            operationId: approveCreditNote
            parameters:
                - name: creditNoteId
                  in: path
                  required: true
                  schema:
                      type: string
                      format: uuid
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            type: object
                            required:
                                - decision
                            properties:
                                decision:
                                    type: string
                                    enum: [approve, reject]
                                comment:
                                    type: string
                                    nullable: true
            responses:
                '200':
                    description: Credit note review captured.
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/ApiSuccessResponse'
    /api/credit-notes/{creditNoteId}/lines:
        put:
            tags:
                - Credit Notes
            summary: Update credit note lines
            operationId: updateCreditNoteLines
            parameters:
                - name: creditNoteId
                  in: path
                  required: true
                  schema:
                      type: string
                      format: uuid
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            type: object
                            required:
                                - lines
                            properties:
                                lines:
                                    type: array
                                    minItems: 1
                                    items:
                                        type: object
                                        required:
                                            - invoice_line_id
                                            - qty_to_credit
                                        properties:
                                            invoice_line_id:
                                                type: integer
                                            qty_to_credit:
                                                type: number
                                            description:
                                                type: string
                                                nullable: true
                                            uom:
                                                type: string
                                                nullable: true
            responses:
                '200':
                    description: Credit note lines updated.
                    content:
                        application/json:
                            schema:
                                allOf:
                                    - $ref: '#/components/schemas/ApiSuccessResponse'
                                    - type: object
                                      properties:
                                          data:
                                              $ref: '#/components/schemas/CreditNote'
    /api/credit-notes/{creditNoteId}/attachments:
        post:
            tags:
                - Credit Notes
            summary: Upload attachment for credit note
            operationId: attachCreditNoteFile
            parameters:
                - name: creditNoteId
                  in: path
                  required: true
                  schema:
                      type: string
                      format: uuid
            requestBody:
                required: true
                content:
                    multipart/form-data:
                        schema:
                            type: object
                            required:
                                - file
                            properties:
                                file:
                                    type: string
                                    format: binary
            responses:
                '200':
                    description: Credit note attachment uploaded.
                    content:
                        application/json:
                            schema:
                                allOf:
                                    - $ref: '#/components/schemas/ApiSuccessResponse'
                                    - type: object
                                      properties:
                                          data:
                                              type: object
                                              properties:
                                                  credit_note:
                                                      $ref: '#/components/schemas/CreditNote'
                                                  attachment:
                                                      $ref: '#/components/schemas/DocumentAttachment'
    # TODO: clarify with spec whether /apply and /reverse endpoints are exposed for credit note settlement workflows.
