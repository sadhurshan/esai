components:
  schemas:
    GoodsReceiptNote:
      type: object
      required:
        - id
        - purchase_order_id
        - grn_number
        - status
      properties:
        id:
          type: integer
        company_id:
          type: integer
        purchase_order_id:
          type: integer
        purchase_order_number:
          type: string
          nullable: true
        po_number:
          type: string
          nullable: true
        grn_number:
          type: string
        number:
          type: string
        status:
          type: string
          enum: [draft, inspecting, posted, variance, rejected]
        inspected_by_id:
          type: integer
          nullable: true
        inspected_at:
          type: string
          format: date-time
          nullable: true
        received_at:
          type: string
          format: date-time
          nullable: true
        posted_at:
          type: string
          format: date-time
          nullable: true
        reference:
          type: string
          nullable: true
        notes:
          type: string
          nullable: true
        supplier_id:
          type: integer
          nullable: true
        supplier_name:
          type: string
          nullable: true
        inspector:
          type: object
          nullable: true
          properties:
            id:
              type: integer
            name:
              type: string
        created_by:
          type: object
          nullable: true
          properties:
            id:
              type: integer
            name:
              type: string
        lines_count:
          type: integer
          nullable: true
        attachments_count:
          type: integer
          nullable: true
        lines:
          type: array
          items:
            $ref: '#/components/schemas/GoodsReceiptLine'
        attachments:
          type: array
          items:
            $ref: '#/components/schemas/DocumentAttachment'
        timeline:
          type: array
          items:
            type: object
            additionalProperties: true
        created_at:
          type: string
          format: date-time
          nullable: true
        updated_at:
          type: string
          format: date-time
          nullable: true
    GoodsReceiptLine:
      type: object
      required:
        - id
        - purchase_order_line_id
        - received_qty
      properties:
        id:
          type: integer
        goods_receipt_note_id:
          type: integer
        purchase_order_line_id:
          type: integer
        po_line_id:
          type: integer
        line_no:
          type: string
          nullable: true
        description:
          type: string
          nullable: true
        ordered_qty:
          type: number
          nullable: true
        received_qty:
          type: number
        accepted_qty:
          type: number
          nullable: true
        rejected_qty:
          type: number
          nullable: true
        previously_received:
          type: number
          nullable: true
        remaining_qty:
          type: number
          nullable: true
        defect_notes:
          type: string
          nullable: true
        notes:
          type: string
          nullable: true
        uom:
          type: string
          nullable: true
        unit_price_minor:
          type: integer
          nullable: true
        currency:
          type: string
          nullable: true
        variance:
          type: object
          nullable: true
          additionalProperties: true
        attachments:
          type: array
          items:
            $ref: '#/components/schemas/DocumentAttachment'
    CompanyGoodsReceiptLineInput:
      type: object
      required:
        - po_line_id
        - qty_received
      properties:
        po_line_id:
          type: integer
        qty_received:
          type: number
        notes:
          type: string
          nullable: true
        uom:
          type: string
          nullable: true
    Ncr:
      type: object
      required:
        - id
        - company_id
        - grn_id
        - po_line_id
        - status
        - reason
      properties:
        id:
          type: integer
        company_id:
          type: integer
        grn_id:
          type: integer
        po_line_id:
          type: integer
        status:
          type: string
          enum: [open, closed]
        disposition:
          type: string
          enum: [rework, return, accept_as_is]
          nullable: true
        reason:
          type: string
        attachments:
          type: array
          items:
            type: object
            properties:
              id:
                type: integer
        raised_by:
          type: object
          nullable: true
          properties:
            id:
              type: integer
            name:
              type: string
        created_at:
          type: string
          format: date-time
          nullable: true
        updated_at:
          type: string
          format: date-time
          nullable: true
    Rma:
      type: object
      required:
        - id
        - status
        - purchase_order_id
      properties:
        id:
          type: string
          format: uuid
        status:
          type: string
          enum: [draft, submitted, reviewing, approved, rejected, closed]
        purchase_order_id:
          type: integer
        reason:
          type: string
        resolution:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
paths:
  /api/purchase-orders/{purchaseOrderId}/grns:
    parameters:
      - name: purchaseOrderId
        in: path
        required: true
        schema:
            type: integer
    get:
      tags:
        - Inventory
      summary: List goods receipt notes for purchase order
      operationId: listGrns
      responses:
        '200':
          description: Collection of goods receipt notes.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiSuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        required:
                          - items
                        properties:
                          items:
                            type: array
                            items:
                              $ref: '#/components/schemas/GoodsReceiptNote'
                          meta:
                            $ref: '#/components/schemas/PageMeta'
    post:
      tags:
        - Inventory
      summary: Create goods receipt note
      operationId: createGrn
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - lines
              properties:
                lines:
                  type: array
                  minItems: 1
                  items:
                    type: object
                    required:
                      - purchase_order_line_id
                      - quantity_received
                    properties:
                      purchase_order_line_id:
                        type: integer
                      quantity_received:
                        type: number
                      quantity_accepted:
                        type: number
                        nullable: true
                      quantity_rejected:
                        type: number
                        nullable: true
                      rejection_reason:
                        type: string
                        nullable: true
                inspected_at:
                  type: string
                  format: date-time
                  nullable: true
      responses:
        '201':
          description: Goods receipt note created.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiSuccessResponse'
  /api/purchase-orders/{purchaseOrderId}/grns/{grnId}:
    parameters:
      - name: purchaseOrderId
        in: path
        required: true
        schema:
          type: integer
      - name: grnId
        in: path
        required: true
        schema:
          type: integer
    get:
      tags:
        - Inventory
      summary: Show goods receipt note
      operationId: showGrn
      responses:
        '200':
          description: Goods receipt details.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiSuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/GoodsReceiptNote'
    put:
      tags:
        - Inventory
      summary: Update goods receipt note
      operationId: updateGrn
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                status:
                  type: string
                  enum: [draft, inspecting, accepted, rejected]
                lines:
                  type: array
                  items:
                    type: object
                    properties:
                      id:
                        type: integer
                      quantity_accepted:
                        type: number
                      quantity_rejected:
                        type: number
                      rejection_reason:
                        type: string
                        nullable: true
      responses:
        '200':
          description: Goods receipt updated.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiSuccessResponse'
    delete:
      tags:
        - Inventory
      summary: Delete goods receipt note
      operationId: deleteGrn
      responses:
        '200':
          description: Goods receipt deleted.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiSuccessResponse'
  /api/receiving/grns:
    get:
      tags:
        - Inventory
      summary: List company goods receipt notes
      operationId: listCompanyGrns
      parameters:
        - $ref: '#/components/parameters/PerPageQuery'
        - $ref: '#/components/parameters/CursorQuery'
        - name: purchase_order_id
          in: query
          schema:
            type: integer
        - name: supplier_id
          in: query
          schema:
            type: integer
        - name: status
          in: query
          schema:
            type: string
            enum: [draft, posted, variance, all]
        - name: received_from
          in: query
          schema:
            type: string
            format: date
        - name: received_to
          in: query
          schema:
            type: string
            format: date
        - name: search
          in: query
          schema:
            type: string
      responses:
        '200':
          description: Cursor paginated goods receipt notes scoped to the authenticated company.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiSuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        required:
                          - items
                          - meta
                        properties:
                          items:
                            type: array
                            items:
                              $ref: '#/components/schemas/GoodsReceiptNote'
                          meta:
                            type: object
                            properties:
                              per_page:
                                type: integer
                              next_cursor:
                                type: string
                                nullable: true
                              prev_cursor:
                                type: string
                                nullable: true
                            additionalProperties: false
    post:
      tags:
        - Inventory
      summary: Record a goods receipt note for a purchase order
      operationId: storeCompanyGrn
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - purchase_order_id
                - lines
              properties:
                purchase_order_id:
                  type: integer
                received_at:
                  type: string
                  format: date-time
                  nullable: true
                reference:
                  type: string
                  nullable: true
                notes:
                  type: string
                  nullable: true
                status:
                  type: string
                  enum: [draft, posted]
                  nullable: true
                lines:
                  type: array
                  minItems: 1
                  items:
                    $ref: '#/components/schemas/CompanyGoodsReceiptLineInput'
      responses:
        '200':
          description: Goods receipt stored.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiSuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/GoodsReceiptNote'
  /api/receiving/grns/{grnId}:
    parameters:
      - name: grnId
        in: path
        required: true
        schema:
          type: integer
    get:
      tags:
        - Inventory
      summary: Show a goods receipt note
      operationId: showCompanyGrn
      responses:
        '200':
          description: Goods receipt details.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiSuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/GoodsReceiptNote'
  /api/receiving/grns/{grnId}/attachments:
    post:
      tags:
        - Inventory
      summary: Upload attachment to goods receipt note
      operationId: attachCompanyGrnFile
      parameters:
        - name: grnId
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - file
              properties:
                file:
                  type: string
                  format: binary
      responses:
        '200':
          description: Attachment uploaded and goods receipt note updated.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiSuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/GoodsReceiptNote'
  /api/receiving/grns/{grnId}/ncrs:
    parameters:
      - name: grnId
        in: path
        required: true
        schema:
          type: integer
    post:
      tags:
        - Inventory
      summary: Raise a non-conformance for a goods receipt line
      operationId: createReceivingNcr
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - purchase_order_line_id
                - reason
              properties:
                purchase_order_line_id:
                  type: integer
                reason:
                  type: string
                disposition:
                  type: string
                  enum: [rework, return, accept_as_is]
                  nullable: true
                documents:
                  type: array
                  items:
                    type: integer
      responses:
        '200':
          description: NCR created for the goods receipt line.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiSuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Ncr'
                      message:
                        type: string
  /api/receiving/ncrs/{ncrId}:
    parameters:
      - name: ncrId
        in: path
        required: true
        schema:
          type: integer
    patch:
      tags:
        - Inventory
      summary: Update or close a non-conformance record
      operationId: updateReceivingNcr
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - status
              properties:
                status:
                  type: string
                  enum: [closed]
                disposition:
                  type: string
                  enum: [rework, return, accept_as_is]
                  nullable: true
      responses:
        '200':
          description: NCR updated.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiSuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Ncr'
                      message:
                        type: string
  /api/rmas:
    get:
      tags:
        - Inventory
      summary: List RMAs
      operationId: listRmas
      responses:
        '200':
          description: Collection of RMAs.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiSuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        required:
                          - items
                        properties:
                          items:
                            type: array
                            items:
                              $ref: '#/components/schemas/Rma'
                          meta:
                            $ref: '#/components/schemas/PageMeta'
  /api/rmas/purchase-orders/{purchaseOrderId}:
    post:
      tags:
        - Inventory
      summary: Create RMA for purchase order
      operationId: createRma
      parameters:
        - name: purchaseOrderId
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - reason
              properties:
                reason:
                  type: string
                attachments:
                  type: array
                  items:
                    type: string
                    format: uuid
      responses:
        '201':
          description: RMA created.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiSuccessResponse'
  /api/rmas/{rmaId}:
    get:
      tags:
        - Inventory
      summary: Retrieve RMA
      operationId: showRma
      parameters:
        - name: rmaId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: RMA detail.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiSuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Rma'
  /api/rmas/{rmaId}/review:
    post:
      tags:
        - Inventory
      summary: Review RMA
      operationId: reviewRma
      parameters:
        - name: rmaId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - decision
              properties:
                decision:
                  type: string
                  enum: [approve, reject]
                comment:
                  type: string
                  nullable: true
      responses:
        '200':
          description: Review recorded.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiSuccessResponse'
