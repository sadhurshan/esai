components:
  schemas:
    Invoice:
      type: object
      required:
        - id
        - company_id
        - purchase_order_id
        - invoice_number
        - status
        - currency
        - total
      properties:
        id:
          type: string
          format: uuid
        company_id:
          type: integer
        purchase_order_id:
          type: integer
        supplier_id:
          type: integer
          nullable: true
        invoice_number:
          type: string
        currency:
          type: string
        status:
          type: string
          enum: [draft, submitted, approved, rejected, paid]
        subtotal:
          type: number
          format: float
        tax_amount:
          type: number
          format: float
        total:
          type: number
          format: float
        match_summary:
          type: object
          properties:
            matched:
              type: integer
            qty_mismatch:
              type: integer
            price_mismatch:
              type: integer
            unmatched:
              type: integer
        document:
          type: object
          nullable: true
          properties:
            id:
              type: string
              format: uuid
            filename:
              type: string
            mime:
              type: string
            size_bytes:
              type: integer
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    InvoiceCollection:
      type: object
      required:
        - items
        - meta
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/Invoice'
        meta:
          $ref: '#/components/schemas/PageMeta'
    CreditNote:
      type: object
      required:
        - id
        - company_id
        - invoice_id
        - credit_number
        - status
        - amount
      properties:
        id:
          type: string
          format: uuid
        company_id:
          type: integer
        invoice_id:
          type: integer
        purchase_order_id:
          type: integer
        credit_number:
          type: string
        currency:
          type: string
        amount:
          type: string
        amount_minor:
          type: integer
        reason:
          type: string
        status:
          type: string
          enum: [draft, pending_review, issued, approved, rejected]
        review_comment:
          type: string
          nullable: true
        issued_by:
          type: integer
          nullable: true
        approved_by:
          type: integer
          nullable: true
        approved_at:
          type: string
          format: date-time
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
paths:
  /api/purchase-orders/{purchaseOrderId}/invoices:
    parameters:
      - name: purchaseOrderId
        in: path
        required: true
        schema:
          type: string
          format: uuid
    get:
      tags:
        - Invoices
      summary: List invoices for a purchase order
      operationId: listInvoicesForPurchaseOrder
      responses:
        '200':
          description: Paginated invoices linked to the purchase order.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiSuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/InvoiceCollection'
    post:
      tags:
        - Invoices
      summary: Create invoice for purchase order
      operationId: createInvoiceForPurchaseOrder
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - invoice_number
                - currency
                - total
                - file
              properties:
                invoice_number:
                  type: string
                currency:
                  type: string
                subtotal:
                  type: number
                  format: float
                tax_amount:
                  type: number
                  format: float
                total:
                  type: number
                  format: float
                file:
                  type: string
                  format: binary
      responses:
        '201':
          description: Invoice captured.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiSuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Invoice'
  /api/invoices/{invoiceId}:
    parameters:
      - name: invoiceId
        in: path
        required: true
        schema:
          type: string
          format: uuid
    get:
      tags:
        - Invoices
      summary: Retrieve invoice
      operationId: showInvoice
      responses:
        '200':
          description: Invoice details.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiSuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Invoice'
        '404':
          $ref: '#/components/responses/NotFound'
    put:
      tags:
        - Invoices
      summary: Update invoice metadata
      operationId: updateInvoice
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                invoice_number:
                  type: string
                status:
                  type: string
                subtotal:
                  type: number
                  format: float
                tax_amount:
                  type: number
                  format: float
                total:
                  type: number
                  format: float
      responses:
        '200':
          description: Invoice updated.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiSuccessResponse'
    delete:
      tags:
        - Invoices
      summary: Delete invoice
      operationId: deleteInvoice
      responses:
        '200':
          description: Invoice deleted.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiSuccessResponse'
  /api/invoices/{invoiceId}/recalculate:
    post:
      tags:
        - Invoices
      summary: Recalculate invoice totals
      operationId: recalculateInvoice
      parameters:
        - name: invoiceId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Recalculated invoice summary.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiSuccessResponse'
  /api/credit-notes:
    get:
      tags:
        - Invoices
      summary: List credit notes
      operationId: listCreditNotes
      parameters:
        - $ref: '#/components/parameters/PerPageQuery'
        - $ref: '#/components/parameters/PageQuery'
      responses:
        '200':
          description: Paginated credit notes.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiSuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        required:
                          - items
                          - meta
                        properties:
                          items:
                            type: array
                            items:
                              $ref: '#/components/schemas/CreditNote'
                          meta:
                            $ref: '#/components/schemas/PageMeta'
  /api/credit-notes/invoices/{invoiceId}:
    post:
      tags:
        - Invoices
      summary: Issue credit note for invoice
      operationId: createCreditNote
      parameters:
        - name: invoiceId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - amount_minor
                - reason
              properties:
                amount_minor:
                  type: integer
                  minimum: 1
                reason:
                  type: string
                attachments:
                  type: array
                  items:
                    type: string
                    format: uuid
      responses:
        '201':
          description: Credit note drafted.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiSuccessResponse'
  /api/credit-notes/{creditNoteId}:
    get:
      tags:
        - Invoices
      summary: Show credit note
      operationId: showCreditNote
      parameters:
        - name: creditNoteId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Credit note detail.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiSuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/CreditNote'
  /api/credit-notes/{creditNoteId}/issue:
    post:
      tags:
        - Invoices
      summary: Issue credit note to supplier
      operationId: issueCreditNote
      parameters:
        - name: creditNoteId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Credit note issued.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiSuccessResponse'
  /api/credit-notes/{creditNoteId}/approve:
    post:
      tags:
        - Invoices
      summary: Approve issued credit note
      operationId: approveCreditNote
      parameters:
        - name: creditNoteId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Credit note approved.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiSuccessResponse'
