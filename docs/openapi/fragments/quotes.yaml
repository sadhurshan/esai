components:
  schemas:
    Quote:
      type: object
      required:
        - id
        - rfq_id
        - supplier_id
        - status
        - currency
        - total_minor
      properties:
        id:
          type: string
          format: uuid
        rfq_id:
          type: integer
        supplier_id:
          type: integer
        status:
          type: string
          enum: [draft, submitted, awarded, withdrawn, expired, lost]
        currency:
          type: string
        unit_price:
          type: number
          format: float
        subtotal:
          type: string
        subtotal_minor:
          type: integer
        tax_amount:
          type: string
        tax_amount_minor:
          type: integer
        total:
          type: string
        total_minor:
          type: integer
        min_order_qty:
          type: integer
          nullable: true
        lead_time_days:
          type: integer
          nullable: true
        note:
          type: string
          nullable: true
        revision_no:
          type: integer
        submitted_by:
          type: integer
          nullable: true
        submitted_at:
          type: string
          format: date-time
          nullable: true
        withdrawn_at:
          type: string
          format: date-time
          nullable: true
        withdraw_reason:
          type: string
          nullable: true
        supplier:
          type: object
          nullable: true
          properties:
            id:
              type: integer
            name:
              type: string
        items:
          type: array
          items:
            $ref: '#/components/schemas/QuoteItem'
        attachments:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
                format: uuid
              filename:
                type: string
              path:
                type: string
              mime:
                type: string
              size_bytes:
                type: integer
        revisions:
          type: array
          items:
            $ref: '#/components/schemas/QuoteRevision'
    QuoteItem:
      type: object
      required:
        - id
        - quote_id
        - rfq_item_id
        - unit_price_minor
      properties:
        id:
          type: string
          format: uuid
        quote_id:
          type: string
          format: uuid
        rfq_item_id:
          type: string
          format: uuid
        currency:
          type: string
        quantity:
          type: number
          format: float
        unit_price:
          type: number
          format: float
        unit_price_minor:
          type: integer
        line_subtotal:
          type: number
          format: float
        line_subtotal_minor:
          type: integer
        tax_total:
          type: number
          format: float
        tax_total_minor:
          type: integer
        line_total:
          type: number
          format: float
        line_total_minor:
          type: integer
        lead_time_days:
          type: integer
          nullable: true
        note:
          type: string
          nullable: true
        status:
          type: string
          nullable: true
        taxes:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
                format: uuid
              tax_code_id:
                type: integer
              rate_percent:
                type: number
                format: float
              amount_minor:
                type: integer
    QuoteRevision:
      type: object
      required:
        - id
        - quote_id
        - revision_no
        - status
      properties:
        id:
          type: string
          format: uuid
        quote_id:
          type: string
          format: uuid
        revision_no:
          type: integer
        status:
          type: string
        submitted_at:
          type: string
          format: date-time
          nullable: true
        note:
          type: string
          nullable: true
    RfqQuote:
      type: object
      required:
        - id
        - rfq_id
        - supplier_id
        - unit_price_usd
        - lead_time_days
        - via
        - status
        - submitted_at
      properties:
        id:
          type: integer
        rfq_id:
          type: integer
        supplier_id:
          type: integer
        supplier_name:
          type: string
          nullable: true
        unit_price_usd:
          type: number
          format: float
        total_price_usd:
          type: number
          format: float
          nullable: true
        revision:
          type: integer
        lead_time_days:
          type: integer
        note:
          type: string
          nullable: true
        attachment_path:
          type: string
          nullable: true
        via:
          type: string
          enum: [direct, bidding]
        status:
          type: string
        submitted_at:
          type: string
          format: date-time
        created_at:
          type: string
          format: date-time
          nullable: true
        updated_at:
          type: string
          format: date-time
          nullable: true
    RfqQuoteCollection:
      type: object
      required:
        - items
        - meta
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/RfqQuote'
        meta:
          type: object
          required:
            - per_page
          properties:
            next_cursor:
              type: string
              nullable: true
            prev_cursor:
              type: string
              nullable: true
            per_page:
              type: integer
    RfqQuoteRequest:
      type: object
      required:
        - supplier_id
        - unit_price_usd
        - lead_time_days
        - via
      properties:
        supplier_id:
          type: integer
        unit_price_usd:
          type: number
          format: float
        lead_time_days:
          type: integer
          minimum: 0
        note:
          type: string
          nullable: true
        via:
          type: string
          enum: [direct, bidding]
        attachment:
          type: string
          format: binary
          nullable: true
    QuoteLineRequest:
      type: object
      required:
        - rfq_item_id
        - lead_time_days
      properties:
        rfq_item_id:
          type: string
          format: uuid
        unit_price_minor:
          type: integer
          nullable: true
        unit_price:
          type: number
          format: float
          nullable: true
        currency:
          type: string
          minLength: 3
          maxLength: 3
          nullable: true
        lead_time_days:
          type: integer
          minimum: 0
        note:
          type: string
          nullable: true
        tax_code_ids:
          type: array
          items:
            type: integer
        status:
          type: string
          nullable: true
    QuoteLineUpdateRequest:
      type: object
      properties:
        unit_price_minor:
          type: integer
          nullable: true
        unit_price:
          type: number
          format: float
          nullable: true
        currency:
          type: string
          minLength: 3
          maxLength: 3
          nullable: true
        lead_time_days:
          type: integer
          minimum: 0
        note:
          type: string
          nullable: true
        tax_code_ids:
          type: array
          items:
            type: integer
        status:
          type: string
          nullable: true
    QuoteSubmissionRequest:
      type: object
      required:
        - supplier_id
        - currency
        - unit_price
        - items
      properties:
        supplier_id:
          type: integer
        currency:
          type: string
          minLength: 3
          maxLength: 3
        unit_price:
          type: number
          format: float
        lead_time_days:
          type: integer
          minimum: 1
          nullable: true
        min_order_qty:
          type: integer
          minimum: 1
          nullable: true
        notes:
          type: string
          nullable: true
        note:
          type: string
          nullable: true
        items:
          type: array
          minItems: 1
          items:
            $ref: '#/components/schemas/QuoteLineRequest'
        attachment:
          type: string
          format: binary
          nullable: true
          description: Optional supporting document uploaded with the quote.
    WithdrawQuoteRequest:
      type: object
      required:
        - reason
      properties:
        reason:
          type: string
          minLength: 3
    QuoteComparisonRow:
      type: object
      required:
        - quote_id
        - rfq_id
        - currency
        - status
        - scores
      properties:
        quote_id:
          type: integer
        rfq_id:
          type: integer
        supplier:
          type: object
          nullable: true
        currency:
          type: string
          minLength: 3
          maxLength: 3
        total_price_minor:
          type: integer
        lead_time_days:
          type: integer
          nullable: true
        status:
          type: string
        attachments_count:
          type: integer
        submitted_at:
          type: string
          format: date-time
          nullable: true
        scores:
          type: object
          required:
            - price
            - lead_time
            - rating
            - composite
            - rank
          properties:
            price:
              type: number
              format: float
            lead_time:
              type: number
              format: float
            rating:
              type: number
              format: float
            composite:
              type: number
              format: float
            rank:
              type: integer
        quote:
          $ref: '#/components/schemas/Quote'
paths:
  /api/rfqs/{rfqId}/quotes:
    parameters:
      - name: rfqId
        in: path
        required: true
        schema:
          type: string
          format: uuid
    get:
      tags:
        - Quotes
      summary: List quotes for an RFQ
      operationId: listQuotesForRfq
      responses:
        '200':
          description: Quotes submitted for the RFQ.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiSuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        required:
                          - items
                        properties:
                          items:
                            type: array
                            items:
                              $ref: '#/components/schemas/Quote'
        '404':
          $ref: '#/components/responses/NotFound'
    post:
      tags:
        - Quotes
      summary: Create quote draft for RFQ
      operationId: createQuoteForRfq
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              $ref: '#/components/schemas/QuoteSubmissionRequest'
      responses:
        '201':
          description: Quote draft created.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiSuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Quote'
        '404':
          $ref: '#/components/responses/NotFound'
        '422':
          $ref: '#/components/responses/ValidationError'
  /api/rfq-quotes/{rfqId}:
    parameters:
      - name: rfqId
        in: path
        required: true
        schema:
          type: string
          format: uuid
    get:
      tags:
        - Quotes
      summary: List RFQ quotes for buyer or invited supplier personas
      operationId: listStandaloneRfqQuotes
      parameters:
        - $ref: '#/components/parameters/CursorQuery'
        - $ref: '#/components/parameters/PerPageQuery'
      responses:
        '200':
          description: Cursor-paginated collection of RFQ quotes.
          headers:
            X-Request-Id:
              $ref: '#/components/headers/XRequestId'
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiSuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/RfqQuoteCollection'
        '401':
          description: Authentication required.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
        '403':
          description: RFQ access denied for the active persona.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
    post:
      tags:
        - Quotes
      summary: Submit a supplier RFQ quote via standalone endpoint
      operationId: submitStandaloneRfqQuote
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              $ref: '#/components/schemas/RfqQuoteRequest'
      responses:
        '201':
          description: RFQ quote created.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiSuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/RfqQuote'
        '401':
          description: Authentication required.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
        '403':
          description: Supplier access denied or RFQ invitation missing.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
        '422':
          $ref: '#/components/responses/ValidationError'
  /api/rfqs/{rfqId}/quotes/compare:
    get:
      tags:
        - Quotes
      summary: Compare quotes for RFQ
      operationId: compareQuotesForRfq
      parameters:
        - name: rfqId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Normalized scoring matrix for all quotes tied to the RFQ.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiSuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        required:
                          - items
                        properties:
                          items:
                            type: array
                            items:
                              $ref: '#/components/schemas/QuoteComparisonRow'
        '404':
          $ref: '#/components/responses/NotFound'
  /api/quotes:
    get:
      tags:
        - Quotes
      summary: List quotes for inbox
      operationId: listQuotes
      parameters:
        - name: inbox
          in: query
          required: true
          schema:
            type: string
            enum: [buyer, supplier]
        - name: sort
          in: query
          required: false
          schema:
            type: string
            enum: [created_at, submitted_at, total_minor, total_price_minor]
        - name: sort_direction
          in: query
          required: false
          schema:
            type: string
            enum: [asc, desc]
        - name: cursor
          in: query
          required: false
          schema:
            type: string
        - name: per_page
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 50
      responses:
        '200':
          description: Quotes routed to the requested inbox.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiSuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        required:
                          - items
                        properties:
                          items:
                            type: array
                            items:
                              $ref: '#/components/schemas/Quote'
    post:
      tags:
        - Quotes
      summary: Submit quote directly
      operationId: submitQuote
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - rfq_id
                - currency
                - items
              properties:
                rfq_id:
                  type: string
                  format: uuid
                supplier_id:
                  type: string
                  format: uuid
                currency:
                  type: string
                lead_time_days:
                  type: integer
                  nullable: true
                min_order_qty:
                  type: integer
                  nullable: true
                note:
                  type: string
                  nullable: true
                status:
                  type: string
                  enum: [draft, submitted]
                  default: submitted
                items:
                  type: array
                  minItems: 1
                  items:
                    type: object
                    required:
                      - rfq_item_id
                      - lead_time_days
                    properties:
                      rfq_item_id:
                        type: string
                        format: uuid
                      unit_price_minor:
                        type: integer
                        nullable: true
                      unit_price:
                        type: number
                        format: float
                        nullable: true
                      currency:
                        type: string
                        minLength: 3
                        maxLength: 3
                        nullable: true
                      lead_time_days:
                        type: integer
                        minimum: 0
                      note:
                        type: string
                        nullable: true
                      tax_code_ids:
                        type: array
                        items:
                          type: integer
                      status:
                        type: string
                        nullable: true
                attachments:
                  type: array
                  items:
                    type: string
                    format: uuid
      responses:
        '201':
          description: Quote submitted.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiSuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Quote'
        '422':
          $ref: '#/components/responses/ValidationError'
  /api/rfqs/{rfqId}/quotes/{quoteId}/revisions:
    parameters:
      - name: rfqId
        in: path
        required: true
        schema:
          type: string
          format: uuid
      - name: quoteId
        in: path
        required: true
        schema:
          type: string
          format: uuid
    get:
      tags:
        - Quotes
      summary: List quote revisions
      operationId: listQuoteRevisions
      responses:
        '200':
          description: Quote revision history.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiSuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        required:
                          - items
                        properties:
                          items:
                            type: array
                            items:
                              $ref: '#/components/schemas/QuoteRevision'
    post:
      tags:
        - Quotes
      summary: Submit quote revision
      operationId: submitQuoteRevision
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - note
                - items
              properties:
                note:
                  type: string
                items:
                  type: array
                  minItems: 1
                  items:
                    type: object
                    required:
                      - rfq_item_id
                      - unit_price_minor
                      - quantity
                    properties:
                      rfq_item_id:
                        type: string
                        format: uuid
                      quantity:
                        type: integer
                      unit_price_minor:
                        type: integer
      responses:
        '201':
          description: Revision accepted.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiSuccessResponse'
  /api/rfqs/{rfqId}/quotes/{quoteId}:
    parameters:
      - name: rfqId
        in: path
        required: true
        schema:
          type: string
          format: uuid
      - name: quoteId
        in: path
        required: true
        schema:
          type: string
          format: uuid
    put:
      tags:
        - Quotes
      summary: Submit quote draft
      operationId: submitQuoteDraft
      responses:
        '200':
          description: Quote submitted.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiSuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Quote'
        '404':
          $ref: '#/components/responses/NotFound'
        '422':
          $ref: '#/components/responses/ValidationError'
    patch:
      tags:
        - Quotes
      summary: Withdraw quote
      operationId: withdrawQuote
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WithdrawQuoteRequest'
      responses:
        '200':
          description: Quote withdrawn.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiSuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Quote'
        '404':
          $ref: '#/components/responses/NotFound'
        '422':
          $ref: '#/components/responses/ValidationError'
  /api/rfqs/{rfqId}/quotes/{quoteId}/withdraw:
    post:
      tags:
        - Quotes
      summary: Withdraw quote
      operationId: withdrawQuote
      parameters:
        - name: rfqId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: quoteId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - reason
              properties:
                reason:
                  type: string
      responses:
        '200':
          description: Quote withdrawn.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiSuccessResponse'
  /api/rfqs/{rfqId}/quotes/{quoteId}/draft:
    parameters:
      - name: rfqId
        in: path
        required: true
        schema:
          type: string
          format: uuid
      - name: quoteId
        in: path
        required: true
        schema:
          type: string
          format: uuid
    patch:
      tags:
        - Quotes
      summary: Update quote draft details
      operationId: updateRfqQuoteDraft
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              additionalProperties: true
      responses:
        '200':
          description: Draft quote updated.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiSuccessResponse'
  /api/quotes/{quoteId}:
    parameters:
      - name: quoteId
        in: path
        required: true
        schema:
          type: string
          format: uuid
    get:
      tags:
        - Quotes
      summary: Fetch a single quote
      operationId: showQuote
      responses:
        '200':
          description: Quote details including lines, attachments, and revisions.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiSuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Quote'
        '404':
          $ref: '#/components/responses/NotFound'
  /api/quotes/{quoteId}/submit:
    post:
      tags:
        - Quotes
      summary: Submit a draft quote
      operationId: submitDraftQuote
      parameters:
        - name: quoteId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Quote submitted successfully.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiSuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Quote'
        '422':
          $ref: '#/components/responses/ValidationError'
  /api/quotes/{quoteId}/shortlist:
    parameters:
      - name: quoteId
        in: path
        required: true
        schema:
          type: string
          format: uuid
    post:
      tags:
        - Quotes
      summary: Add quote to shortlist
      operationId: shortlistQuote
      responses:
        '200':
          description: Quote shortlisted for award consideration.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiSuccessResponse'
    delete:
      tags:
        - Quotes
      summary: Remove quote from shortlist
      operationId: unshortlistQuote
      responses:
        '200':
          description: Quote removed from shortlist.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiSuccessResponse'
  /api/quotes/{quoteId}/lines:
    parameters:
      - name: quoteId
        in: path
        required: true
        schema:
          type: string
          format: uuid
    post:
      tags:
        - Quotes
      summary: Add line to draft quote
      operationId: addQuoteLine
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/QuoteLineRequest'
      responses:
        '201':
          description: Line added and totals recalculated.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiSuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Quote'
        '422':
          $ref: '#/components/responses/ValidationError'
  /api/quotes/{quoteId}/lines/{quoteItemId}:
    parameters:
      - name: quoteId
        in: path
        required: true
        schema:
          type: string
          format: uuid
      - name: quoteItemId
        in: path
        required: true
        schema:
          type: string
          format: uuid
    put:
      tags:
        - Quotes
      summary: Update an existing quote line
      operationId: updateQuoteLine
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/QuoteLineUpdateRequest'
      responses:
        '200':
          description: Line updated and totals recalculated.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiSuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Quote'
        '422':
          $ref: '#/components/responses/ValidationError'
    delete:
      tags:
        - Quotes
      summary: Remove a quote line
      operationId: deleteQuoteLine
      responses:
        '200':
          description: Updated quote after removal.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiSuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Quote'
  /api/supplier/quotes:
    get:
      tags:
        - Quotes
      summary: List quotes for the authenticated supplier company
      operationId: listSupplierQuotes
      parameters:
        - name: rfq_id
          in: query
          required: false
          schema:
            type: string
            format: uuid
        - name: status
          in: query
          required: false
          schema:
            type: string
            description: Comma-delimited list of statuses to include.
        - name: rfq_number
          in: query
          required: false
          schema:
            type: string
        - $ref: '#/components/parameters/PageQuery'
        - $ref: '#/components/parameters/PerPageQuery'
        - name: sort
          in: query
          required: false
          schema:
            type: string
            enum: [created_at, submitted_at, total_minor]
      responses:
        '200':
          description: Supplier quotes list.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiSuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        required:
                          - items
                          - meta
                        properties:
                          items:
                            type: array
                            items:
                              $ref: '#/components/schemas/Quote'
                          meta:
                            type: object
                            properties:
                              total:
                                type: integer
                              per_page:
                                type: integer
                              current_page:
                                type: integer
                              last_page:
                                type: integer
