components:
  schemas:
    WebhookSubscription:
      type: object
      required:
        - id
        - company_id
        - url
        - events
        - active
      properties:
        id:
          type: string
          format: uuid
        company_id:
          type: integer
        url:
          type: string
          format: uri
        secret_hint:
          type: string
          nullable: true
        events:
          type: array
          items:
            type: string
        active:
          type: boolean
        retry_policy:
          type: object
          additionalProperties: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    WebhookDelivery:
      type: object
      required:
        - id
        - subscription_id
        - event
        - status
        - attempts
      properties:
        id:
          type: string
          format: uuid
        subscription_id:
          type: string
          format: uuid
        company_id:
          type: integer
          nullable: true
        event:
          type: string
        status:
          type: string
          enum: [pending, dispatched, delivered, failed, dead_letter]
        attempts:
          type: integer
        last_error:
          type: string
          nullable: true
        dispatched_at:
          type: string
          format: date-time
          nullable: true
        delivered_at:
          type: string
          format: date-time
          nullable: true
        created_at:
          type: string
          format: date-time
    EventDelivery:
      type: object
      required:
        - id
        - subscription_id
        - event
        - status
        - attempts
      properties:
        id:
          type: integer
        subscription_id:
          type: integer
        endpoint:
          type: string
          format: uri
          nullable: true
        event:
          type: string
        status:
          type: string
          enum: [pending, success, failed, dead_letter]
        attempts:
          type: integer
        max_attempts:
          type: integer
          nullable: true
        latency_ms:
          type: integer
          nullable: true
        response_code:
          type: integer
          nullable: true
        response_body:
          type: string
          nullable: true
        last_error:
          type: string
          nullable: true
        payload:
          type: object
          nullable: true
          additionalProperties: true
        dead_lettered_at:
          type: string
          format: date-time
          nullable: true
        dispatched_at:
          type: string
          format: date-time
          nullable: true
        delivered_at:
          type: string
          format: date-time
          nullable: true
        created_at:
          type: string
          format: date-time
paths:
  /api/admin/webhook-subscriptions:
    get:
      tags:
        - Webhooks
      summary: List webhook subscriptions
      operationId: adminListWebhookSubscriptions
      responses:
        '200':
          description: Paginated webhook subscriptions.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiSuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          items:
                            type: array
                            items:
                              $ref: '#/components/schemas/WebhookSubscription'
                          meta:
                            $ref: '#/components/schemas/PageMeta'
    post:
      tags:
        - Webhooks
      summary: Create webhook subscription
      operationId: adminCreateWebhookSubscription
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - company_id
                - url
                - events
              properties:
                company_id:
                  type: integer
                url:
                  type: string
                  format: uri
                secret:
                  type: string
                events:
                  type: array
                  items:
                    type: string
                active:
                  type: boolean
                retry_policy:
                  type: object
                  additionalProperties: true
      responses:
        '201':
          description: Webhook subscription created.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiSuccessResponse'
  /api/admin/webhook-subscriptions/{subscriptionId}:
    parameters:
      - name: subscriptionId
        in: path
        required: true
        schema:
          type: string
          format: uuid
    get:
      tags:
        - Webhooks
      summary: Retrieve webhook subscription
      operationId: adminShowWebhookSubscription
      responses:
        '200':
          description: Webhook subscription detail.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiSuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/WebhookSubscription'
    put:
      tags:
        - Webhooks
      summary: Update webhook subscription
      operationId: adminUpdateWebhookSubscription
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                url:
                  type: string
                  format: uri
                events:
                  type: array
                  items:
                    type: string
                active:
                  type: boolean
                retry_policy:
                  type: object
                  additionalProperties: true
      responses:
        '200':
          description: Webhook subscription updated.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiSuccessResponse'
    delete:
      tags:
        - Webhooks
      summary: Remove webhook subscription
      operationId: adminDeleteWebhookSubscription
      responses:
        '200':
          description: Webhook subscription removed.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiSuccessResponse'
  /api/webhooks/stripe/invoice/payment-succeeded:
    post:
      tags:
        - Webhooks
      summary: Stripe invoice payment succeeded event hook
      operationId: stripeInvoicePaymentSucceeded
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              additionalProperties: true
      responses:
        '200':
          description: Webhook acknowledged.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiSuccessResponse'
  /api/webhooks/stripe/invoice/payment-failed:
    post:
      tags:
        - Webhooks
      summary: Stripe invoice payment failed event hook
      operationId: stripeInvoicePaymentFailed
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              additionalProperties: true
      responses:
        '200':
          description: Webhook acknowledged.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiSuccessResponse'
  /api/webhooks/stripe/customer/subscription-updated:
    post:
      tags:
        - Webhooks
      summary: Stripe subscription updated webhook
      operationId: stripeSubscriptionUpdated
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              additionalProperties: true
      responses:
        '200':
          description: Webhook acknowledged.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiSuccessResponse'
  /api/billing/stripe/webhook:
    post:
      tags:
        - Webhooks
      summary: Stripe catch-all billing webhook
      operationId: stripeBillingCatchAll
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              additionalProperties: true
      responses:
        '200':
          description: Webhook received and optionally processed.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiSuccessResponse'
        '400':
          description: Invalid Stripe signature or malformed payload.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
  /api/admin/webhook-deliveries:
    get:
      tags:
        - Webhooks
      summary: List webhook deliveries
      operationId: adminListWebhookDeliveries
      parameters:
        - name: subscription_id
          in: query
          schema:
            type: string
            format: uuid
        - $ref: '#/components/parameters/PageQuery'
        - $ref: '#/components/parameters/PerPageQuery'
      responses:
        '200':
          description: Paginated history of webhook delivery attempts.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiSuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          items:
                            type: array
                            items:
                              $ref: '#/components/schemas/WebhookDelivery'
                          meta:
                            $ref: '#/components/schemas/PageMeta'
  /api/admin/webhook-deliveries/{deliveryId}/retry:
    post:
      tags:
        - Webhooks
      summary: Retry failed webhook delivery
      operationId: adminRetryWebhookDelivery
      parameters:
        - name: deliveryId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '202':
          description: Delivery queued for retry.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiSuccessResponse'
  /api/events/deliveries:
    get:
      tags:
        - Webhooks
      summary: List webhook event deliveries for the tenant
      operationId: listEventDeliveries
      parameters:
        - $ref: '#/components/parameters/CursorQuery'
        - $ref: '#/components/parameters/PerPageQuery'
        - name: status
          in: query
          schema:
            type: string
            enum: [pending, success, failed, dead_letter]
        - name: event
          in: query
          schema:
            type: string
        - name: subscription_id
          in: query
          schema:
            type: integer
        - name: endpoint
          in: query
          schema:
            type: string
        - name: search
          in: query
          schema:
            type: string
        - name: dlq_only
          in: query
          schema:
            type: boolean
      responses:
        '200':
          description: Cursor-paginated event deliveries for the company or platform admin scope.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiSuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        required:
                          - items
                          - meta
                        properties:
                          items:
                            type: array
                            items:
                              $ref: '#/components/schemas/EventDelivery'
                          meta:
                            type: object
                            properties:
                              per_page:
                                type: integer
                              next_cursor:
                                type: string
                                nullable: true
                              prev_cursor:
                                type: string
                                nullable: true
  /api/events/deliveries/{deliveryId}/retry:
    post:
      tags:
        - Webhooks
      summary: Retry a failed delivery owned by the tenant
      operationId: retryEventDelivery
      parameters:
        - name: deliveryId
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Delivery re-queued.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiSuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          id:
                            type: integer
  /api/events/dlq/replay:
    post:
      tags:
        - Webhooks
      summary: Replay dead-lettered deliveries
      operationId: replayDeadLetters
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - ids
              properties:
                ids:
                  type: array
                  minItems: 1
                  maxItems: 50
                  items:
                    type: integer
      responses:
        '200':
          description: Dead-lettered deliveries scheduled for replay.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiSuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          replayed:
                            type: integer
